<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriManager Pro</title>
    
    <!-- Librer√≠as Externas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase (Modular/Compat compatible) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #4361ee;
            --primary-hover: #3a0ca3;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --danger: #f72585;
            --dark: #212529;
            --light: #f8f9fa;
            --white: #ffffff;
            --border-radius: 12px;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: var(--dark);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Navegaci√≥n y Header */
        header {
            background: var(--white);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .hamburger-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .hamburger-button span {
            display: block;
            width: 25px;
            height: 3px;
            background: var(--dark);
            border-radius: 3px;
            transition: 0.3s;
        }

        .nav-overlay {
            position: fixed;
            top: 0;
            left: -100%;
            width: 280px;
            height: 100%;
            background: var(--dark);
            z-index: 2000;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding-top: 60px;
            box-shadow: 10px 0 30px rgba(0,0,0,0.2);
        }

        .nav-overlay.active { left: 0; }

        .nav-links { list-style: none; padding: 0; margin: 0; }
        .nav-links li a {
            display: block;
            padding: 18px 25px;
            color: #ccc;
            text-decoration: none;
            font-size: 1.1em;
            transition: 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-links li a:hover, .nav-links li a.active {
            color: var(--white);
            background: rgba(255,255,255,0.05);
            border-left-color: var(--primary);
        }

        .nav-close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        /* Contenedor Principal */
        main {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px 100px 15px;
        }

        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* UI Components */
        .card {
            background: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 1px solid #edf2f7;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: #f1f3f5; color: var(--dark); }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9em; }
        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: 0.3s;
        }
        .input-field:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); }

        /* Tablas M√≥viles */
        .table-wrapper { overflow-x: auto; border-radius: var(--border-radius); border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 13px; color: #64748b; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; }

        @media (max-width: 768px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; margin-bottom: 15px; border: 1px solid #eee; border-radius: 10px; padding: 10px; }
            .responsive-table td { display: flex; justify-content: space-between; padding: 10px 5px; border: none; font-size: 14px; }
            .responsive-table td::before { content: attr(data-label); font-weight: bold; color: #64748b; }
        }

        /* Calendario Turnos */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #e2e8f0;
            border: 1px solid #e2e8f0;
        }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-day-label { background: #f8fafc; padding: 10px; text-align: center; font-weight: bold; font-size: 12px; }
        .calendar-cell {
            background: white;
            min-height: 100px;
            padding: 5px;
            cursor: pointer;
            transition: 0.2s;
        }
        .calendar-cell:hover { background: #f1f5f9; }
        .calendar-cell.other-month { opacity: 0.3; }
        .day-num { font-weight: bold; font-size: 14px; margin-bottom: 5px; display: block; }
        .turno-pill {
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Notificaciones Badge */
        .badge {
            background: var(--danger);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            position: absolute;
            top: -5px;
            right: -5px;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
            cursor: pointer;
            z-index: 900;
            border: none;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 15px;
            backdrop-filter: blur(4px);
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            width: 100%;
            max-width: 600px;
            border-radius: 15px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
        }
        .modal-large { max-width: 900px; }

        /* Chat IA */
        .chat-box { height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 10px; background: #f9fafb; border-radius: 10px; border: 1px solid #eee; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; line-height: 1.4; }
        .msg-user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg-bot { align-self: flex-start; background: white; border: 1px solid #eee; border-bottom-left-radius: 2px; }

        /* Loader */
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Gr√°ficos */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .charts-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="loadingScreen" class="loading-screen">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: 600;">Procesando...</p>
    </div>

    <nav id="navOverlay" class="nav-overlay">
        <span class="nav-close" onclick="toggleMenu()">&times;</span>
        <ul class="nav-links">
            <li><a href="#" onclick="showView('patients')" class="active">üë• Pacientes</a></li>
            <li><a href="#" onclick="showView('agenda')">üìÖ Agenda de Turnos</a></li>
            <li><a href="#" onclick="showView('foodLib')">üçé Biblioteca de Alimentos</a></li>
            <li><a href="#" onclick="showView('calc')">‚öñÔ∏è Calculadora IMC</a></li>
            <li><a href="#" onclick="showView('assistant')">ü§ñ Asistente IA</a></li>
        </ul>
    </nav>

    <header>
        <button class="hamburger-button" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </button>
        <h2 id="headerTitle" style="margin:0; font-size: 1.2rem;">NutriManager</h2>
        <div id="headerBadge" style="position:relative; cursor:pointer;" onclick="showUpcomingTurnos()">
            üîî <span id="notifCount" class="badge" style="display:none">0</span>
        </div>
    </header>

    <main>
        <!-- VISTA: LISTA DE PACIENTES -->
        <section id="view-patients" class="view-section active">
            <div class="card">
                <input type="search" id="patientSearch" class="input-field" placeholder="üîç Buscar paciente por nombre..." oninput="filterPatients()">
            </div>
            <div class="table-wrapper">
                <table class="responsive-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Tel√©fono</th>
                            <th>√öltimo Peso</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="patientTableBody">
                        <!-- Carga Din√°mica -->
                    </tbody>
                </table>
            </div>
            <button class="fab" onclick="openPatientModal()">+</button>
        </section>

        <!-- VISTA: DETALLE DE PACIENTE (Mediciones) -->
        <section id="view-details" class="view-section">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="btn btn-ghost" onclick="showView('patients')">‚¨Ö Volver</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="generateSmartPlan()">‚ú® Generar Plan</button>
                    <button class="btn btn-ghost" onclick="exportToPdf()">üìÑ PDF</button>
                </div>
            </div>

            <div class="card">
                <h2 id="detailPatientName" style="margin-top:0">Nombre del Paciente</h2>
                <div class="charts-grid">
                    <div style="height: 250px;"><canvas id="weightChart"></canvas></div>
                    <div style="height: 250px;"><canvas id="fatChart"></canvas></div>
                </div>
            </div>

            <h3>Historial de Mediciones</h3>
            <div id="measurementsHistory">
                <!-- Tarjetas de mediciones -->
            </div>
            <button class="fab" onclick="openMeasurementModal()">+</button>
        </section>

        <!-- VISTA: AGENDA (Calendario) -->
        <section id="view-agenda" class="view-section">
            <div class="card">
                <div class="calendar-header">
                    <button class="btn btn-ghost" onclick="changeMonth(-1)">‚óÄ</button>
                    <h2 id="calendarMonthYear" style="margin:0">Enero 2024</h2>
                    <button class="btn btn-ghost" onclick="changeMonth(1)">‚ñ∂</button>
                </div>
                <div id="calendarGrid" class="calendar-grid">
                    <!-- Din√°mico -->
                </div>
            </div>
        </section>

        <!-- VISTA: ALIMENTOS -->
        <section id="view-foodLib" class="view-section">
            <div class="card" style="display:flex; gap:10px;">
                <input type="search" id="foodSearch" class="input-field" placeholder="üçé Buscar alimento..." oninput="renderFoodLibrary()">
                <button class="btn btn-primary" onclick="openFoodModal()">+</button>
            </div>
            <div id="foodGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px;">
                <!-- Din√°mico -->
            </div>
        </section>

        <!-- VISTA: CALCULADORA -->
        <section id="view-calc" class="view-section">
            <div class="card" style="max-width: 500px; margin: 0 auto;">
                <h2>Calculadora de IMC</h2>
                <div class="input-group">
                    <label>Peso (kg)</label>
                    <input type="number" id="calcPeso" class="input-field" placeholder="70">
                </div>
                <div class="input-group">
                    <label>Altura (cm)</label>
                    <input type="number" id="calcAltura" class="input-field" placeholder="175">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="quickCalc()">Calcular</button>
                <div id="calcResult" class="card" style="margin-top:20px; text-align:center; display:none; background:#e0f2fe;">
                    <!-- Resultado -->
                </div>
            </div>
        </section>

        <!-- VISTA: ASISTENTE IA -->
        <section id="view-assistant" class="view-section">
            <div class="card">
                <div id="chatBox" class="chat-box">
                    <div class="msg msg-bot">Hola, soy tu asistente nutricional. ¬øQu√© duda tienes hoy?</div>
                </div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <input type="text" id="chatInput" class="input-field" placeholder="Pregunta sobre alimentaci√≥n, recetas..." onkeypress="if(event.key==='Enter') sendChatMessage()">
                    <button class="btn btn-primary" onclick="sendChatMessage()">‚û§</button>
                </div>
            </div>
        </section>
    </main>

    <!-- MODALES -->

    <!-- Modal Paciente -->
    <div id="modalPatient" class="modal">
        <div class="modal-content">
            <h2 id="modalPatientTitle">Nuevo Paciente</h2>
            <form id="patientForm">
                <input type="hidden" id="p_id">
                <div class="input-group"><label>Nombre y Apellido</label><input type="text" id="p_nombre" class="input-field" required></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div class="input-group"><label>Fecha Nacimiento</label><input type="date" id="p_nacimiento" class="input-field" required></div>
                    <div class="input-group"><label>Sexo</label><select id="p_sexo" class="input-field"><option value="masculino">Masculino</option><option value="femenino">Femenino</option></select></div>
                </div>
                <div class="input-group"><label>Tel√©fono (WhatsApp)</label><input type="tel" id="p_tel" class="input-field" placeholder="54911..." required></div>
                <div class="input-group"><label>Peso Inicial (kg)</label><input type="number" id="p_peso" step="0.1" class="input-field" required></div>
                <div style="display:flex; gap:10px; margin-top:10px">
                    <button type="submit" class="btn btn-primary" style="flex:1">Guardar</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Medici√≥n -->
    <div id="modalMeasurement" class="modal">
        <div class="modal-content">
            <h2>Registrar Medici√≥n</h2>
            <form id="measurementForm">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div class="input-group"><label>Peso Actual (kg)</label><input type="number" id="m_peso" step="0.1" class="input-field" required></div>
                    <div class="input-group"><label>Peso Objetivo (kg)</label><input type="number" id="m_objetivo" step="0.1" class="input-field" required></div>
                </div>
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px">
                    <div class="input-group"><label>PT</label><input type="number" id="m_pt" step="0.1" class="input-field"></div>
                    <div class="input-group"><label>PSE</label><input type="number" id="m_pse" step="0.1" class="input-field"></div>
                    <div class="input-group"><label>PSI</label><input type="number" id="m_psi" step="0.1" class="input-field"></div>
                    <div class="input-group"><label>PA</label><input type="number" id="m_pa" step="0.1" class="input-field"></div>
                </div>
                <div class="input-group">
                    <label>Actividad F√≠sica</label>
                    <select id="m_actividad" class="input-field">
                        <option value="sedentario">Sedentario</option>
                        <option value="ligero">Ligero (1-3 d√≠as)</option>
                        <option value="moderado">Moderado (3-5 d√≠as)</option>
                        <option value="fuerte">Fuerte (6-7 d√≠as)</option>
                    </select>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div class="input-group"><label>Horas Sue√±o</label><input type="number" id="m_sueno" class="input-field" value="7"></div>
                    <div class="input-group"><label>Nivel Estr√©s (1-10)</label><input type="range" id="m_estres" min="1" max="10" style="width:100%"></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:10px">Guardar Medici√≥n</button>
            </form>
        </div>
    </div>

    <!-- Modal Plan Inteligente (Display) -->
    <div id="modalPlan" class="modal">
        <div class="modal-content modal-large">
            <header>
                <h2 style="margin:0">‚ú® Plan Inteligente Generado</h2>
                <button onclick="closeModals()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </header>
            <div id="planContent" style="margin-top:20px;">
                <!-- Din√°mico -->
            </div>
        </div>
    </div>

    <!-- Modal Turno -->
    <div id="modalTurno" class="modal">
        <div class="modal-content">
            <h2 id="modalTurnoTitle">Agendar Turno</h2>
            <form id="turnoForm">
                <input type="hidden" id="t_id">
                <input type="hidden" id="t_fecha">
                <div class="input-group"><label>Paciente</label><input type="text" id="t_paciente" class="input-field" required></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div class="input-group"><label>Hora</label><input type="time" id="t_hora" class="input-field" required></div>
                    <div class="input-group"><label>WhatsApp</label><input type="tel" id="t_whatsapp" class="input-field" required></div>
                </div>
                <div class="input-group"><label>Obra Social</label><input type="text" id="t_os" class="input-field"></div>
                <div class="input-group"><label>Observaciones</label><textarea id="t_obs" class="input-field" rows="2"></textarea></div>
                <div style="display:flex; gap:10px">
                    <button type="submit" class="btn btn-primary" style="flex:1">Guardar</button>
                    <button type="button" id="btnDelTurno" class="btn btn-danger" style="display:none" onclick="deleteTurno()">Borrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Alimento -->
    <div id="modalFood" class="modal">
        <div class="modal-content">
            <h2>Gestionar Alimento</h2>
            <form id="foodForm">
                <input type="hidden" id="f_id">
                <div class="input-group"><label>Nombre</label><input type="text" id="f_nombre" class="input-field" required></div>
                <div class="input-group">
                    <label>Categor√≠a</label>
                    <select id="f_cat" class="input-field">
                        <option value="proteina">Prote√≠na</option>
                        <option value="carbohidrato">Carbohidrato</option>
                        <option value="grasa">Grasa</option>
                        <option value="verdura">Verdura / Fibra</option>
                    </select>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px">
                    <div class="input-group"><label>Prot (g)</label><input type="number" step="0.1" id="f_p" class="input-field" required></div>
                    <div class="input-group"><label>Carb (g)</label><input type="number" step="0.1" id="f_c" class="input-field" required></div>
                    <div class="input-group"><label>Grasa (g)</label><input type="number" step="0.1" id="f_g" class="input-field" required></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:10px">Guardar Alimento</button>
            </form>
        </div>
    </div>

    <script>
        // 1. CONFIGURACI√ìN Y ESTADO
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'nutri-manager-v2';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "", // Se requiere apiKey funcional en el entorno real
            authDomain: "medicion-imc.firebaseapp.com",
            projectId: "medicion-imc",
            storageBucket: "medicion-imc.appspot.com",
            messagingSenderId: "544674177518",
            appId: "1:544674177518:web:c060519e65a2913e0beeff"
        };
        
        // Inicializaci√≥n
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Rutas de colecciones siguiendo REGLA 1
        const getColPath = (name) => `artifacts/${appId}/public/data/${name}`;

        let state = {
            currentView: 'patients',
            user: null,
            patients: [],
            selectedPatientId: null,
            selectedPatient: null,
            measurements: [],
            foodLibrary: [],
            turnos: [],
            currentCalendarDate: new Date()
        };

        // 2. AUTENTICACI√ìN Y CARGA INICIAL (REGLA 3)
        document.addEventListener('DOMContentLoaded', async () => {
            showLoader(true);
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
                
                auth.onAuthStateChanged(user => {
                    state.user = user;
                    if (user) initializeDataListeners();
                });
            } catch (err) {
                console.error("Auth error:", err);
                showErrorMessage("Error de conexi√≥n. Por favor recargue.");
            }
        });

        function initializeDataListeners() {
            if (!state.user) return;

            // Listeners en tiempo real siguiendo REGLA 1
            db.collection(getColPath("pacientes")).orderBy("nombreCompleto").onSnapshot(snap => {
                state.patients = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(state.currentView === 'patients') renderPatients();
            }, err => console.error("Patients error:", err));

            db.collection(getColPath("alimentos")).orderBy("name").onSnapshot(snap => {
                state.foodLibrary = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(state.currentView === 'foodLib') renderFoodLibrary();
            }, err => console.error("Food error:", err));

            db.collection(getColPath("turnos")).onSnapshot(snap => {
                state.turnos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(state.currentView === 'agenda') renderCalendar();
                updateNotifBadge();
            }, err => console.error("Turnos error:", err));

            showLoader(false);
        }

        // 3. NAVEGACI√ìN
        function toggleMenu() { document.getElementById('navOverlay').classList.toggle('active'); }
        
        function showView(view, params = {}) {
            state.currentView = view;
            if (document.getElementById('navOverlay').classList.contains('active')) toggleMenu();
            
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            
            const target = document.getElementById(`view-${view}`);
            if(target) target.classList.add('active');
            
            // L√≥gica por vista
            if(view === 'patients') renderPatients();
            if(view === 'agenda') renderCalendar();
            if(view === 'foodLib') renderFoodLibrary();
            if(view === 'details') loadPatientDetails(params.id);
            
            window.scrollTo(0,0);
        }

        // 4. L√ìGICA PACIENTES
        function renderPatients(filtered = null) {
            const list = filtered || state.patients;
            const body = document.getElementById('patientTableBody');
            body.innerHTML = list.map(p => `
                <tr>
                    <td data-label="Nombre" style="font-weight:bold; color:var(--primary); cursor:pointer" onclick="showView('details', {id:'${p.id}'})">${p.nombreCompleto}</td>
                    <td data-label="Tel√©fono">${p.telefono}</td>
                    <td data-label="√öltimo Peso">${p.ultimoPeso || '-'} kg</td>
                    <td data-label="Acciones">
                        <button class="btn btn-ghost" style="padding:5px 10px" onclick="openPatientModal('${p.id}')">‚úèÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterPatients() {
            const val = document.getElementById('patientSearch').value.toLowerCase();
            renderPatients(state.patients.filter(p => p.nombreCompleto.toLowerCase().includes(val)));
        }

        // 5. DETALLES Y MEDICIONES
        let weightChart = null, fatChart = null;

        async function loadPatientDetails(id) {
            state.selectedPatientId = id;
            const p = state.patients.find(x => x.id === id);
            state.selectedPatient = p;
            document.getElementById('detailPatientName').innerText = p.nombreCompleto;

            // Ruta de subcolecci√≥n seg√∫n REGLA 1 (mismo prefijo)
            db.collection(getColPath("pacientes")).doc(id).collection("mediciones").orderBy("fecha", "asc").onSnapshot(snap => {
                state.measurements = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMeasurements();
                renderCharts();
            }, err => console.error("Measurements error:", err));
        }

        function renderMeasurements() {
            const container = document.getElementById('measurementsHistory');
            container.innerHTML = [...state.measurements].reverse().map(m => {
                const r = m.resultados;
                const date = m.fecha.toDate().toLocaleDateString();
                return `
                    <div class="card" style="cursor:pointer" onclick="viewMeasurementDetails('${m.id}')">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <strong>${date}</strong>
                            <span class="btn btn-ghost" style="padding:4px 8px; font-size:12px">Ver Detalles</span>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; margin-top:10px; font-size:14px">
                            <span>Peso: <b>${r.pesoActual} kg</b></span>
                            <span>Grasa: <b>${r.tejidoGrasoPorcentaje.toFixed(1)}%</b></span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCharts() {
            if(state.measurements.length < 2) return;
            const labels = state.measurements.map(m => m.fecha.toDate().toLocaleDateString());
            const weights = state.measurements.map(m => m.resultados.pesoActual);
            const fats = state.measurements.map(m => m.resultados.tejidoGrasoPorcentaje);

            if(weightChart) weightChart.destroy();
            weightChart = new Chart(document.getElementById('weightChart'), {
                type: 'line',
                data: { labels, datasets: [{ label: 'Peso (kg)', data: weights, borderColor: '#4361ee', tension: 0.3, fill: true, backgroundColor: 'rgba(67, 97, 238, 0.1)' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            if(fatChart) fatChart.destroy();
            fatChart = new Chart(document.getElementById('fatChart'), {
                type: 'line',
                data: { labels, datasets: [{ label: 'Grasa (%)', data: fats, borderColor: '#f72585', tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // 6. AGENDA Y CALENDARIO
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const date = state.currentCalendarDate;
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            document.getElementById('calendarMonthYear').innerText = `${monthNames[month]} ${year}`;

            ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'].forEach(d => {
                const el = document.createElement('div'); el.className = 'calendar-day-label'; el.innerText = d; grid.appendChild(el);
            });

            for(let i = firstDay; i > 0; i--) {
                const el = document.createElement('div'); el.className = 'calendar-cell other-month';
                el.innerHTML = `<span class="day-num">${prevMonthLastDay - i + 1}</span>`;
                grid.appendChild(el);
            }

            for(let d = 1; d <= daysInMonth; d++) {
                const el = document.createElement('div'); el.className = 'calendar-cell';
                const fullDate = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                el.innerHTML = `<span class="day-num">${d}</span>`;
                const dayTurnos = state.turnos.filter(t => t.fecha === fullDate);
                dayTurnos.forEach(t => {
                    const pill = document.createElement('div');
                    pill.className = 'turno-pill';
                    pill.innerText = `${t.hora} ${t.paciente}`;
                    pill.onclick = (e) => { e.stopPropagation(); openTurnoModal(t.id); };
                    el.appendChild(pill);
                });
                el.onclick = () => openTurnoModal(null, fullDate);
                grid.appendChild(el);
            }
        }

        function changeMonth(dir) {
            state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth() + dir);
            renderCalendar();
        }

        // 7. PLAN INTELIGENTE Y PDF
        async function generateSmartPlan() {
            if(state.measurements.length === 0) return alert("Registra una medici√≥n primero");
            showLoader(true);
            const last = state.measurements[state.measurements.length - 1];
            const p = state.selectedPatient;
            const hoy = new Date();
            const nac = p.fechaNacimiento.toDate();
            let edad = hoy.getFullYear() - nac.getFullYear();
            if(hoy.getMonth() < nac.getMonth()) edad--;

            let bmr = (10 * last.resultados.pesoActual) + (6.25 * 170) - (5 * edad) + (p.sexo === 'masculino' ? 5 : -161);
            const factorAct = { sedentario: 1.2, ligero: 1.375, moderado: 1.55, fuerte: 1.725 }[last.objetivos.actividadTipo] || 1.2;
            let tdee = bmr * factorAct;
            const kcalTarget = last.objetivos.pesoObjetivo < last.resultados.pesoActual ? tdee - 500 : tdee + 300;
            
            const prots = state.foodLibrary.filter(f => f.category === 'proteina');
            const carbs = state.foodLibrary.filter(f => f.category === 'carbohidrato');
            const fibers = state.foodLibrary.filter(f => f.category === 'verdura');

            const menuHTML = `
                <div class="card" style="border-left: 5px solid var(--primary)">
                    <h3>Meta Diaria: ${Math.round(kcalTarget)} kcal</h3>
                    <p><b>Prote√≠na:</b> ${Math.round(kcalTarget*0.3/4)}g | <b>Carbs:</b> ${Math.round(kcalTarget*0.4/4)}g | <b>Grasas:</b> ${Math.round(kcalTarget*0.3/9)}g</p>
                </div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px">
                    <div class="card"><h4>üåÖ Desayuno</h4><ul><li>100g ${prots[0]?.name || 'Huevo'}</li><li>60g ${carbs[0]?.name || 'Avena'}</li></ul></div>
                    <div class="card"><h4>ü•ó Almuerzo</h4><ul><li>150g ${prots[1]?.name || 'Pollo'}</li><li>100g ${carbs[1]?.name || 'Arroz'}</li></ul></div>
                    <div class="card"><h4>‚òï Merienda</h4><ul><li>1 Yogurt</li><li>30g Frutos Secos</li></ul></div>
                    <div class="card"><h4>üçó Cena</h4><ul><li>150g ${prots[2]?.name || 'Pescado'}</li><li>Verduras libres</li></ul></div>
                </div>
            `;
            document.getElementById('planContent').innerHTML = menuHTML;
            document.getElementById('modalPlan').classList.add('active');
            await db.collection(getColPath("pacientes")).doc(p.id).collection("mediciones").doc(last.id).update({
                planInteligente: { menu: menuHTML, kcal: Math.round(kcalTarget) }
            });
            showLoader(false);
        }

        async function exportToPdf() {
            if(state.measurements.length === 0) return alert("No hay datos para exportar");
            showLoader(true);
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            const p = state.selectedPatient;

            pdf.setFontSize(22);
            pdf.setTextColor(67, 97, 238);
            pdf.text(p.nombreCompleto, 105, 20, { align: 'center' });
            pdf.setFontSize(14);
            pdf.setTextColor(33, 37, 41);
            pdf.text("Informe de Evoluci√≥n Antropom√©trica", 105, 30, { align: 'center' });

            const charts = await html2canvas(document.querySelector('.charts-grid'));
            pdf.addImage(charts.toDataURL('image/png'), 'PNG', 10, 40, 190, 80);

            pdf.autoTable({
                startY: 130,
                head: [['Fecha', 'Peso (kg)', '% Grasa', 'Kg Grasa']],
                body: state.measurements.map(m => [
                    m.fecha.toDate().toLocaleDateString(),
                    m.resultados.pesoActual,
                    m.resultados.tejidoGrasoPorcentaje.toFixed(1),
                    m.resultados.kilosGrasaTotal.toFixed(1)
                ]),
                theme: 'striped',
                headStyles: { fillColor: [67, 97, 238] }
            });

            pdf.save(`Informe_${p.nombreCompleto.replace(' ','_')}.pdf`);
            showLoader(false);
        }

        // 8. ASISTENTE IA
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const box = document.getElementById('chatBox');
            const msg = input.value.trim();
            if(!msg) return;
            box.innerHTML += `<div class="msg msg-user">${msg}</div>`;
            input.value = '';
            box.scrollTop = box.scrollHeight;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`, {
                    method: 'POST',
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Experto nutricionista: ${msg}` }] }] })
                });
                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;
                box.innerHTML += `<div class="msg msg-bot">${aiText}</div>`;
                box.scrollTop = box.scrollHeight;
            } catch (e) {
                box.innerHTML += `<div class="msg msg-bot" style="color:red">Error de conexi√≥n con IA.</div>`;
            }
        }

        // 9. HELPERS Y CRUD
        function showLoader(show) { document.getElementById('loadingScreen').style.display = show ? 'flex' : 'none'; }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
        function showErrorMessage(msg) { alert(msg); }
        
        function openPatientModal(id = null) {
            const form = document.getElementById('patientForm');
            form.reset();
            document.getElementById('p_id').value = id || '';
            document.getElementById('modalPatientTitle').innerText = id ? 'Editar Paciente' : 'Nuevo Paciente';
            if(id) {
                const p = state.patients.find(x => x.id === id);
                document.getElementById('p_nombre').value = p.nombreCompleto;
                document.getElementById('p_tel').value = p.telefono;
                document.getElementById('p_peso').value = p.ultimoPeso;
                document.getElementById('p_sexo').value = p.sexo;
                document.getElementById('p_nacimiento').value = p.fechaNacimiento.toDate().toISOString().split('T')[0];
            }
            document.getElementById('modalPatient').classList.add('active');
        }

        document.getElementById('patientForm').onsubmit = async (e) => {
            e.preventDefault();
            showLoader(true);
            const id = document.getElementById('p_id').value;
            const data = {
                nombreCompleto: document.getElementById('p_nombre').value,
                telefono: document.getElementById('p_tel').value,
                ultimoPeso: parseFloat(document.getElementById('p_peso').value),
                sexo: document.getElementById('p_sexo').value,
                fechaNacimiento: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('p_nacimiento').value)),
                fechaUltimoRegistro: firebase.firestore.Timestamp.now()
            };
            if(id) await db.collection(getColPath("pacientes")).doc(id).update(data);
            else await db.collection(getColPath("pacientes")).add(data);
            closeModals();
            showLoader(false);
        };

        function openMeasurementModal() { document.getElementById('measurementForm').reset(); document.getElementById('modalMeasurement').classList.add('active'); }
        document.getElementById('measurementForm').onsubmit = async (e) => {
            e.preventDefault();
            showLoader(true);
            const peso = parseFloat(document.getElementById('m_peso').value);
            const pt = parseFloat(document.getElementById('m_pt').value || 0);
            const pse = parseFloat(document.getElementById('m_pse').value || 0);
            const psi = parseFloat(document.getElementById('m_psi').value || 0);
            const pa = parseFloat(document.getElementById('m_pa').value || 0);
            const grasaPct = ((pt + pse + psi + pa) * 0.153) + 5.783;
            const data = {
                fecha: firebase.firestore.Timestamp.now(),
                objetivos: {
                    pesoObjetivo: parseFloat(document.getElementById('m_objetivo').value),
                    actividadTipo: document.getElementById('m_actividad').value,
                    horasSueno: parseFloat(document.getElementById('m_sueno').value),
                    nivelEstres: parseInt(document.getElementById('m_estres').value)
                },
                resultados: {
                    pesoActual: peso,
                    tejidoGrasoPorcentaje: grasaPct,
                    kilosGrasaTotal: (peso * grasaPct) / 100
                }
            };
            await db.collection(getColPath("pacientes")).doc(state.selectedPatientId).collection("mediciones").add(data);
            await db.collection(getColPath("pacientes")).doc(state.selectedPatientId).update({ ultimoPeso: peso, fechaUltimoRegistro: data.fecha });
            closeModals();
            showLoader(false);
        };

        function openTurnoModal(id = null, date = null) {
            const form = document.getElementById('turnoForm');
            form.reset();
            document.getElementById('t_id').value = id || '';
            document.getElementById('t_fecha').value = date || '';
            document.getElementById('btnDelTurno').style.display = id ? 'block' : 'none';
            if(id) {
                const t = state.turnos.find(x => x.id === id);
                document.getElementById('t_paciente').value = t.paciente;
                document.getElementById('t_hora').value = t.hora;
                document.getElementById('t_whatsapp').value = t.whatsapp;
                document.getElementById('t_os').value = t.os;
                document.getElementById('t_obs').value = t.obs;
            }
            document.getElementById('modalTurno').classList.add('active');
        }

        document.getElementById('turnoForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('t_id').value;
            const data = {
                paciente: document.getElementById('t_paciente').value,
                hora: document.getElementById('t_hora').value,
                whatsapp: document.getElementById('t_whatsapp').value,
                os: document.getElementById('t_os').value,
                obs: document.getElementById('t_obs').value,
                fecha: id ? state.turnos.find(x=>x.id===id).fecha : document.getElementById('t_fecha').value
            };
            if(id) await db.collection(getColPath("turnos")).doc(id).update(data);
            else await db.collection(getColPath("turnos")).add(data);
            closeModals();
        };

        async function deleteTurno() {
            const id = document.getElementById('t_id').value;
            if(id && confirm("¬øBorrar turno?")) {
                await db.collection(getColPath("turnos")).doc(id).delete();
                closeModals();
            }
        }

        function openFoodModal() { document.getElementById('foodForm').reset(); document.getElementById('modalFood').classList.add('active'); }
        document.getElementById('foodForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('f_nombre').value,
                category: document.getElementById('f_cat').value,
                protein: parseFloat(document.getElementById('f_p').value),
                carbs: parseFloat(document.getElementById('f_c').value),
                fats: parseFloat(document.getElementById('f_g').value)
            };
            await db.collection(getColPath("alimentos")).add(data);
            closeModals();
        };

        function renderFoodLibrary() {
            const container = document.getElementById('foodGrid');
            const val = document.getElementById('foodSearch').value.toLowerCase();
            const filtered = state.foodLibrary.filter(f => f.name.toLowerCase().includes(val));
            container.innerHTML = filtered.map(f => `
                <div class="card">
                    <div style="display:flex; justify-content:space-between">
                        <strong>${f.name}</strong>
                        <span style="font-size:10px; padding:2px 5px; background:#eee; border-radius:5px">${f.category}</span>
                    </div>
                    <div style="font-size:12px; margin-top:8px; display:flex; gap:10px">
                        <span>P: ${f.protein}g</span> <span>C: ${f.carbs}g</span> <span>G: ${f.fats}g</span>
                    </div>
                </div>
            `).join('');
        }

        function updateNotifBadge() {
            const todayStr = new Date().toISOString().split('T')[0];
            const upcoming = state.turnos.filter(t => t.fecha >= todayStr);
            const badge = document.getElementById('notifCount');
            if(upcoming.length > 0) {
                badge.innerText = upcoming.length;
                badge.style.display = 'block';
            } else badge.style.display = 'none';
        }

        function showUpcomingTurnos() {
            const todayStr = new Date().toISOString().split('T')[0];
            const upcoming = state.turnos.filter(t => t.fecha >= todayStr).sort((a,b) => a.fecha.localeCompare(b.fecha));
            if(upcoming.length === 0) return alert("No hay turnos pr√≥ximos.");
            let list = "Pr√≥ximos Turnos:\n" + upcoming.slice(0,5).map(t => `- ${t.fecha}: ${t.paciente} (${t.hora})`).join('\n');
            alert(list);
        }

        function quickCalc() {
            const p = parseFloat(document.getElementById('calcPeso').value);
            const a = parseFloat(document.getElementById('calcAltura').value) / 100;
            if(!p || !a) return;
            const imc = (p / (a*a)).toFixed(1);
            let cat = imc < 18.5 ? 'Bajo peso' : imc < 25 ? 'Normal' : imc < 30 ? 'Sobrepeso' : 'Obesidad';
            const res = document.getElementById('calcResult');
            res.innerHTML = `<h3>IMC: ${imc}</h3><p>Categor√≠a: <b>${cat}</b></p>`;
            res.style.display = 'block';
        }

        async function viewMeasurementDetails(id) {
            const m = state.measurements.find(x => x.id === id);
            if(m && m.planInteligente) {
                document.getElementById('planContent').innerHTML = m.planInteligente.menu;
                document.getElementById('modalPlan').classList.add('active');
            } else {
                alert("Detalles b√°sicos:\nPeso: " + m.resultados.pesoActual + " kg\nGrasa: " + m.resultados.tejidoGrasoPorcentaje.toFixed(1) + "%");
            }
        }

    </script>
</body>
</html>
