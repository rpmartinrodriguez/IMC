<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriManager Pro - M√°xima Edici√≥n</title>
    
    <!-- Librer√≠as Externas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            /* Colores Violetas */
            --primary: #7b2cbf;
            --primary-dark: #5a189a;
            --primary-light: #9d4edd;
            --secondary: #c77dff;
            --accent: #e0aaff;
            --success: #2ecc71;
            --danger: #ef4444;
            --warning: #f3722c; /* Naranja vibrante para hoy */
            --warning-light: #f9c74f77; /* Amarillo suave para pr√≥ximos d√≠as */
            --dark: #240046;
            --light: #f3e8ff;
            --bg: #f8f4ff;
            --white: #ffffff;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(123, 44, 191, 0.15);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); color: var(--dark); margin: 0; padding: 0; min-height: 100vh; }

        /* --- NAVEGACI√ìN --- */
        header { background: var(--white); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(123, 44, 191, 0.1); }
        
        .hamburger { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; gap: 5px; z-index: 2100; position: relative; transition: 0.3s; }
        .hamburger span { width: 25px; height: 3px; background: var(--primary); border-radius: 3px; transition: 0.3s; }
        .hamburger.open span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .hamburger.open span:nth-child(2) { opacity: 0; }
        .hamburger.open span:nth-child(3) { transform: rotate(-45deg) translate(6px, -7px); }
        
        .nav-overlay { position: fixed; top: 0; left: -100%; width: 100%; height: 100%; background: rgba(36, 0, 70, 0.5); z-index: 2000; transition: 0.4s; visibility: hidden; }
        .nav-overlay.active { left: 0; visibility: visible; }
        .nav-content { width: 280px; height: 100%; background: var(--dark); padding-top: 80px; box-shadow: 5px 0 20px rgba(0,0,0,0.3); }
        .nav-links { list-style: none; padding: 0; margin: 0; }
        .nav-links li a { display: block; padding: 18px 25px; color: var(--accent); text-decoration: none; font-size: 1.1em; border-left: 4px solid transparent; transition: 0.3s; }
        .nav-links li a:hover, .nav-links li a.active { color: white; background: rgba(255,255,255,0.05); border-left-color: var(--secondary); }

        /* --- CONTENIDO --- */
        main { max-width: 1100px; margin: 20px auto; padding: 0 15px 100px 15px; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COMPONENTES UI --- */
        .card { background: var(--white); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid #e9d5ff; }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: var(--light); color: var(--primary); }
        .btn-whatsapp { background: #25d366; color: white; border-radius: 8px; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        .input-field { width: 100%; padding: 12px 15px; border: 2px solid #e9d5ff; border-radius: 8px; font-size: 16px; margin-bottom: 15px; outline: none; }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(123, 44, 191, 0.1); }
        
        /* --- CALENDARIO --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e9d5ff; border: 1px solid #e9d5ff; border-radius: 8px; overflow: hidden; }
        .calendar-cell { background: white; min-height: 110px; padding: 8px; cursor: pointer; position: relative; transition: 0.2s; overflow-y: auto; }
        .calendar-cell:hover { filter: brightness(0.95); }
        
        /* Degradados Alerta */
        .cell-today { background: var(--warning) !important; border: 2px solid #d35400; }
        .cell-today .day-n { color: white !important; }
        .cell-next-3 { background: var(--warning-light) !important; }
        
        .day-n { font-weight: bold; font-size: 14px; color: var(--primary); margin-bottom: 5px; display: block; }
        .turno-pill { background: var(--primary); color: white; font-size: 10px; padding: 3px 6px; border-radius: 4px; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cell-today .turno-pill { background: white; color: var(--warning); font-weight: bold; }

        /* --- MODALES --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(36, 0, 70, 0.6); display: none; align-items: center; justify-content: center; z-index: 3000; padding: 15px; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 550px; border-radius: 20px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative; border-top: 8px solid var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-large { max-width: 900px; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #aaa; border: none; background: none; font-weight: bold; }

        /* --- EVOLUCI√ìN & GR√ÅFICOS --- */
        .evolution-charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-box { background: white; border: 1px solid #e9d5ff; border-radius: var(--radius); padding: 15px; height: 300px; }

        /* --- REPORTES --- */
        .best-month-card { background: linear-gradient(135deg, #7b2cbf, #c77dff); color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 25px; text-align: center; box-shadow: 0 10px 20px rgba(123, 44, 191, 0.2); }

        /* --- TABLAS --- */
        .table-wrapper { overflow-x: auto; border-radius: var(--radius); border: 1px solid #e9d5ff; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8f4ff; padding: 15px; text-align: left; font-size: 13px; color: var(--primary); text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f3e8ff; }

        /* --- UTILIDADES --- */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 10px 25px rgba(123, 44, 191, 0.4); cursor: pointer; border: none; z-index: 900; }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 45px; height: 45px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 10px; }
        .data-item { background: var(--bg); padding: 10px; border-radius: 8px; border: 1px solid #e9d5ff; }
        .data-item strong { display: block; color: var(--primary-dark); font-size: 11px; text-transform: uppercase; margin-bottom: 2px; }

        .time-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .time-slot { padding: 10px; border-radius: 8px; border: 2px solid #e9d5ff; background: white; color: var(--primary); font-weight: bold; text-align: center; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .time-slot.selected { background: var(--primary); color: white; border-color: var(--primary-dark); }
        .time-slot.taken { background: #f1f1f1; color: #aaa; text-decoration: line-through; border-color: #eee; cursor: not-allowed; }

        .notif-badge { background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; position: absolute; top: -5px; right: -5px; font-weight: bold; border: 1px solid white; }
        .notif-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f3e8ff; }

        @media (max-width: 768px) {
            .calendar-cell { min-height: 85px; padding: 4px; }
            .evolution-charts-container { grid-template-columns: 1fr; }
            .time-grid { grid-template-columns: repeat(3, 1fr); }
            td[data-label]::before { content: attr(data-label); font-weight: bold; float: left; color: var(--primary); }
            .res-table thead { display: none; }
            .res-table tr { display: block; margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 10px; background: white; }
            .res-table td { display: block; text-align: right; border-bottom: 1px solid #eee; padding: 10px 5px; }
        }
    </style>
</head>
<body>

    <div id="mainLoader" class="loader-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: 600; color: var(--primary);">NutriManager Pro...</p>
    </div>

    <!-- Men√∫ Lateral Minimizable -->
    <div id="navOverlay" class="nav-overlay" onclick="toggleMenu()">
        <nav class="nav-content" onclick="event.stopPropagation()">
            <ul class="nav-links">
                <li><a href="#" onclick="switchView('agenda')" id="link-agenda" class="active">üìÖ Agenda Nutricional</a></li>
                <li><a href="#" onclick="switchView('patients')" id="link-patients">üë• Mis Pacientes</a></li>
                <li><a href="#" onclick="switchView('foods')" id="link-foods">üçé Biblioteca Alimentos</a></li>
                <li><a href="#" onclick="switchView('ai')" id="link-ai">ü§ñ Asistente IA</a></li>
            </ul>
        </nav>
    </div>

    <header>
        <button id="hamburger-btn" class="hamburger" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </button>
        <h2 id="viewHeaderTitle" style="margin:0; font-size: 1.1rem; color: var(--primary)">NutriManager Pro</h2>
        <div style="position:relative; cursor:pointer; font-size: 22px; color: var(--primary);" onclick="openNotificationsModal()">
            üîî <span id="notifBadge" class="notif-badge" style="display:none">0</span>
        </div>
    </header>

    <main>
        <!-- VISTA: AGENDA (INICIO) -->
        <section id="view-agenda" class="view-section active">
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button class="btn btn-ghost" onclick="changeMonth(-1)">‚óÄ</button>
                    <h2 id="calendarLabel" style="margin:0; font-size: 1.2rem; color: var(--primary-dark)">Cargando Agenda...</h2>
                    <button class="btn btn-ghost" onclick="changeMonth(1)">‚ñ∂</button>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
        </section>

        <!-- VISTA: PACIENTES -->
        <section id="view-patients" class="view-section">
            <div class="card" style="display:flex; gap:10px;">
                <input type="search" id="patientSearch" class="input-field" style="margin:0" placeholder="üîç Buscar paciente..." oninput="renderPatients()">
                <button class="btn btn-primary" onclick="openPatientModal()">+</button>
            </div>
            <div class="table-wrapper">
                <table class="res-table">
                    <thead>
                        <tr><th>Paciente</th><th>WhatsApp</th><th>Acci√≥n</th></tr>
                    </thead>
                    <tbody id="patientListBody"></tbody>
                </table>
            </div>
        </section>

        <!-- VISTA: DETALLE PACIENTE / EVOLUCI√ìN -->
        <section id="view-details" class="view-section">
            <div style="display:flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap:10px">
                <button class="btn btn-ghost" onclick="switchView('patients')">‚¨Ö Volver</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-warning" onclick="generateSuccessReport()">üèÜ Reporte Estrella</button>
                    <button class="btn btn-primary" onclick="generateSmartPlan()">‚ú® Plan IA</button>
                    <button class="btn btn-ghost" onclick="exportEvolutionPDF()">üìÑ PDF</button>
                </div>
            </div>

            <div id="reportContainer"></div>

            <div class="card">
                <h2 id="detName" style="margin-top:0">Paciente</h2>
                <div class="evolution-charts-container">
                    <div class="chart-box"><canvas id="chartGeneral"></canvas></div>
                    <div class="chart-box"><canvas id="chartFat"></canvas></div>
                    <div class="chart-box"><canvas id="chartPliegues"></canvas></div>
                    <div class="chart-box"><canvas id="chartComparison"></canvas></div>
                </div>
            </div>

            <h3>Historial de Evaluaciones</h3>
            <div id="measurementList"></div>
            <button class="fab" onclick="openMeasureModal()">+</button>
        </section>

        <!-- VISTA: ALIMENTOS -->
        <section id="view-foods" class="view-section">
            <div class="card" style="display:flex; gap:10px">
                <input type="search" id="foodSearch" class="input-field" style="margin:0" placeholder="üçé Buscar..." oninput="renderFoods()">
                <button class="btn btn-primary" onclick="openFoodModal()">+</button>
            </div>
            <div id="foodGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px"></div>
        </section>

        <!-- VISTA: IA -->
        <section id="view-ai" class="view-section">
            <div class="card">
                <div id="chatBox" style="height: 400px; overflow-y: auto; background: #fdfaff; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; gap: 10px; border: 1px solid #e9d5ff;"></div>
                <div style="display:flex; gap:10px; margin-top:15px">
                    <input type="text" id="chatInput" class="input-field" style="margin:0" placeholder="Pregunta..." onkeypress="if(event.key==='Enter') sendAIRequest()">
                    <button class="btn btn-primary" onclick="sendAIRequest()">‚û§</button>
                </div>
            </div>
        </section>
    </main>

    <!-- MODALES -->

    <!-- Modal Notificaciones Pr√≥ximas (CENTRO) -->
    <div id="modalNotifications" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModals()">&times;</button>
            <h2 style="color: var(--primary); margin-top: 0; font-size: 1.3rem;">üìå Turnos Pr√≥ximos</h2>
            <div id="notifListArea" style="max-height: 400px; overflow-y: auto;"></div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="closeModals()">Entendido</button>
        </div>
    </div>

    <!-- Modal Day View -->
    <div id="modalDayView" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModals()">&times;</button>
            <h2 id="dayViewTitle" style="color: var(--primary); margin-top: 0;">Detalle del D√≠a</h2>
            <div id="dayTurnosList"></div>
            <button class="btn btn-primary" style="width:100%; margin-top:15px" id="btnAddTurnoToday">+ Nuevo Turno</button>
        </div>
    </div>

    <!-- Modal Formulario Turno -->
    <div id="modalTurnoForm" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModals()">&times;</button>
            <h2 id="turnoFormTitle" style="color: var(--primary); margin-top: 0;">Agendar</h2>
            <form id="formTurno">
                <input type="hidden" id="t_id"><input type="hidden" id="t_date"><input type="hidden" id="t_selected_time" required>
                <label>Paciente</label>
                <input type="text" id="t_paciente" class="input-field" list="patientsList" required placeholder="Nombre...">
                <datalist id="patientsList"></datalist>
                <label style="display:block; margin-bottom: 12px; font-weight: bold;">Horario:</label>
                <div id="timeGrid" class="time-grid"></div>
                <label>WhatsApp</label>
                <input type="tel" id="t_phone" class="input-field" placeholder="54911..." required>
                <label>Notas</label>
                <textarea id="t_obs" class="input-field" rows="2"></textarea>
                <div style="display:flex; gap:10px">
                    <button type="submit" class="btn btn-primary" style="flex:1">Guardar</button>
                    <button type="button" id="btnDeleteTurno" class="btn btn-danger" style="display:none" onclick="deleteTurno()">Borrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Medici√≥n -->
    <div id="modalMeasure" class="modal">
        <div class="modal-content modal-large">
            <button class="close-modal" onclick="closeModals()">&times;</button>
            <h2 id="measureModalTitle" style="color: var(--primary); margin-top: 0;">Evaluaci√≥n</h2>
            <form id="formMeasure">
                <input type="hidden" id="edit_m_id">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                    <div><label>Peso Actual (kg)</label><input type="number" id="m_w" step="0.1" class="input-field" required></div>
                    <div><label>Peso Meta (kg)</label><input type="number" id="m_goal" step="0.1" class="input-field" required></div>
                </div>
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px">
                    <div><label>PT (mm)</label><input type="number" id="m_pt" class="input-field" step="0.1" value="0"></div>
                    <div><label>PSE (mm)</label><input type="number" id="m_pse" class="input-field" step="0.1" value="0"></div>
                    <div><label>PSI (mm)</label><input type="number" id="m_psi" class="input-field" step="0.1" value="0"></div>
                    <div><label>PA (mm)</label><input type="number" id="m_pa" class="input-field" value="0" step="0.1"></div>
                </div>
                <label>Actividad F√≠sica</label>
                <select id="m_act" class="input-field">
                    <option value="sedentario">Sedentario</option>
                    <option value="ligero">Ejercicio Ligero</option>
                    <option value="moderado">Ejercicio Moderado</option>
                    <option value="fuerte">Atleta / Fuerte</option>
                </select>
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:10px">Guardar Datos</button>
            </form>
        </div>
    </div>

    <!-- Modal Paciente -->
    <div id="modalPatient" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModals()">&times;</button>
            <h2 id="pTitle">Paciente</h2>
            <form id="formPatient">
                <input type="hidden" id="edit_p_id">
                <label>Nombre Completo</label><input type="text" id="p_name" class="input-field" required>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div><label>Nacimiento</label><input type="date" id="p_birth" class="input-field" required></div>
                    <div><label>Sexo</label><select id="p_gender" class="input-field"><option value="femenino">Femenino</option><option value="masculino">Masculino</option></select></div>
                </div>
                <label>WhatsApp</label><input type="tel" id="p_phone" class="input-field" required>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>

    <!-- Modal Alimento -->
    <div id="modalFood" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModals()">&times;</button>
            <h2 style="color: var(--primary)">Nuevo Alimento</h2>
            <form id="formFood">
                <label>Nombre</label><input type="text" id="f_n" class="input-field" required>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px">
                    <div><label>P</label><input type="number" id="f_p" class="input-field" value="0"></div>
                    <div><label>C</label><input type="number" id="f_ca" class="input-field" value="0"></div>
                    <div><label>G</label><input type="number" id="f_g" class="input-field" value="0"></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>

    <script>
        // 1. CONFIGURACI√ìN FIREBASE (ID FIJO PARA PERSISTENCIA TOTAL)
        const appId = "nutrimanager_permanent_pro_final_v100"; 
        const firebaseConfig = {
            apiKey: "AIzaSyASQiAEMuqx4jAP6q0a4kwHQHcQOYC_EcQ",
            authDomain: "medicion-imc.firebaseapp.com",
            projectId: "medicion-imc",
            storageBucket: "medicion-imc.appspot.com",
            messagingSenderId: "544674177518",
            appId: "1:544674177518:web:c060519e65a2913e0beeff"
        };
        const getPath = (col) => `artifacts/${appId}/public/data/${col}`;

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let state = {
            view: 'agenda', patients: [], turnos: [], foods: [], measures: [],
            selPat: null, calDate: new Date(), user: null, isInitial: true
        };
        let charts = {};

        // 2. INICIO
        document.addEventListener('DOMContentLoaded', async () => {
            showLoader(true);
            try {
                await auth.signInAnonymously();
                auth.onAuthStateChanged(user => {
                    if (user) {
                        state.user = user;
                        startApp();
                    }
                });
                
                // Inicializar listeners de formularios (Soluciona el error TypeError de null)
                initFormHandlers();

            } catch (e) { console.error(e); showLoader(false); }
        });

        function startApp() {
            db.collection(getPath("pacientes")).orderBy("nombreCompleto").onSnapshot(s => {
                state.patients = s.docs.map(d => ({id: d.id, ...d.data()}));
                updatePatientDatalist();
                if(state.view === 'patients') renderPatients();
            });

            db.collection(getPath("turnos")).onSnapshot(s => {
                state.turnos = s.docs.map(d => ({id: d.id, ...d.data()}));
                if(state.view === 'agenda') renderCalendar();
                updateBadge();
                if(state.isInitial && state.turnos.length > 0) {
                    checkAndShowPriorityModal();
                    state.isInitial = false;
                }
            });

            db.collection(getPath("alimentos")).orderBy("name").onSnapshot(s => {
                state.foods = s.docs.map(d => ({id: d.id, ...d.data()}));
                if(state.view === 'foods') renderFoods();
            });
            showLoader(false);
        }

        // 3. NAVEGACI√ìN
        function toggleMenu() {
            document.getElementById('navOverlay').classList.toggle('active');
            document.getElementById('hamburger-btn').classList.toggle('open');
        }

        function switchView(view, params = {}) {
            state.view = view;
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            document.getElementById(`view-${view}`).classList.add('active');
            const link = document.getElementById(`link-${view === 'details' ? 'patients' : view}`);
            if (link) link.classList.add('active');

            if (view === 'agenda') renderCalendar();
            if (view === 'patients') renderPatients();
            if (view === 'details') loadPatientDetails(params.id);
            if (document.getElementById('navOverlay').classList.contains('active')) toggleMenu();
            window.scrollTo(0,0);
        }

        // 4. CALENDARIO CON ALERTAS DEGRADADAS
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            const y = state.calDate.getFullYear(), m = state.calDate.getMonth();
            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m + 1, 0).getDate();
            const names = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
            document.getElementById('calendarLabel').innerText = `${names[m]} ${y}`;

            const today = new Date(); today.setHours(0,0,0,0);
            const limit = new Date(); limit.setDate(today.getDate() + 3);

            ['D','L','M','M','J','V','S'].forEach(d => {
                const el = document.createElement('div'); el.style.textAlign='center'; el.style.padding='10px'; el.style.fontWeight='bold'; el.style.color='var(--primary)'; el.innerText=d; grid.appendChild(el);
            });

            for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));

            for(let d=1; d<=days; d++) {
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const cd = new Date(y, m, d); cd.setHours(0,0,0,0);
                const cell = document.createElement('div'); cell.className = 'calendar-cell';
                
                if (cd.getTime() === today.getTime()) cell.classList.add('cell-today');
                else if (cd > today && cd <= limit) cell.classList.add('cell-warning-next');

                cell.innerHTML = `<span class="day-n">${d}</span>`;
                state.turnos.filter(t => t.date === ds).sort((a,b) => a.time.localeCompare(b.time)).slice(0, 2).forEach(t => {
                    const p = document.createElement('div'); p.className = 'turno-pill'; p.innerText = `${t.time} ${t.paciente}`; cell.appendChild(p);
                });
                cell.onclick = () => openDayView(ds);
                grid.appendChild(cell);
            }
        }
        function changeMonth(dir) { state.calDate.setMonth(state.calDate.getMonth() + dir); renderCalendar(); }

        // 5. ALERTAS EMERGENTES (CENTRO)
        function checkAndShowPriorityModal() {
            const today = new Date(); today.setHours(0,0,0,0);
            const limit = new Date(); limit.setDate(today.getDate() + 3);
            const list = state.turnos.filter(t => {
                const d = new Date(t.date + 'T00:00:00'); return d >= today && d <= limit;
            });
            if(list.length > 0) openNotificationsModal();
        }

        function openNotificationsModal() {
            const today = new Date(); today.setHours(0,0,0,0);
            const todayStr = new Date().toISOString().split('T')[0];
            const limit = new Date(); limit.setDate(today.getDate() + 3);
            
            const list = state.turnos.filter(t => {
                const d = new Date(t.date + 'T00:00:00'); return d >= today && d <= limit;
            }).sort((a,b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));

            const container = document.getElementById('notifListArea');
            if(list.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:#aaa;">Sin turnos pr√≥ximos.</p>';
            } else {
                container.innerHTML = list.map(t => `
                    <div class="notif-item">
                        <div style="flex:1">
                            <strong>${t.paciente} ${t.date === todayStr ? '<span style="color:var(--danger)">[HOY]</span>' : ''}</strong>
                            <br><small>üìÖ ${t.date} - ‚è∞ ${t.time} hs</small>
                        </div>
                        <button class="btn btn-whatsapp" onclick="sendWa('${t.phone}', '${t.paciente}', '${t.date}', '${t.time}')">WhatsApp üì±</button>
                    </div>`).join('');
            }
            document.getElementById('modalNotifications').classList.add('active');
        }

        // --- L√ìGICA DE TURNOS ---
        function openDayView(date) {
            const dTurnos = state.turnos.filter(t => t.date === date).sort((a,b) => a.time.localeCompare(b.time));
            document.getElementById('dayViewTitle').innerText = `Turnos del ${date}`;
            const list = document.getElementById('dayTurnosList');
            list.innerHTML = dTurnos.length ? '' : '<p style="text-align:center; padding:15px; color:#999;">Vac√≠o.</p>';
            dTurnos.forEach(t => {
                const item = document.createElement('div');
                item.className = 'day-view-item';
                item.innerHTML = `<div style="flex:1"><strong>${t.time} hs - ${t.paciente}</strong></div>
                    <div style="display:flex; gap:8px">
                        <button class="btn btn-whatsapp" onclick="sendWa('${t.phone}', '${t.paciente}', '${t.date}', '${t.time}')">üì±</button>
                        <button class="btn btn-ghost" onclick="openTurnoForm('${date}', '${t.id}')">‚úèÔ∏è</button>
                    </div>`;
                list.appendChild(item);
            });
            document.getElementById('btnAddTurnoToday').onclick = () => openTurnoForm(date);
            document.getElementById('modalDayView').classList.add('active');
        }

        function openTurnoForm(date, id = null) {
            const f = document.getElementById('formTurno'); f.reset();
            document.getElementById('t_id').value = id || '';
            document.getElementById('t_date').value = date;
            document.getElementById('t_selected_time').value = '';
            document.getElementById('btnDeleteTurno').style.display = id ? 'block' : 'none';

            const grid = document.getElementById('timeGrid'); grid.innerHTML = '';
            const taken = state.turnos.filter(t => t.date === date && t.id !== id).map(t => t.time);
            for(let h=7; h<=20; h++) {
                ['00', '30'].forEach(m => {
                    const time = `${String(h).padStart(2,'0')}:${m}`;
                    const slot = document.createElement('div'); slot.className = 'time-slot';
                    if (taken.includes(time)) slot.classList.add('taken');
                    else slot.onclick = () => { document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected')); slot.classList.add('selected'); document.getElementById('t_selected_time').value = time; };
                    slot.innerText = time; grid.appendChild(slot);
                });
            }
            if (id) {
                const t = state.turnos.find(x => x.id === id);
                document.getElementById('t_paciente').value = t.paciente; document.getElementById('t_phone').value = t.phone; document.getElementById('t_obs').value = t.obs;
                setTimeout(() => { document.querySelectorAll('.time-slot').forEach(s => { if(s.innerText === t.time) s.click(); }); }, 50);
            }
            document.getElementById('modalTurnoForm').classList.add('active');
        }

        // --- M√ìDULO PACIENTES & GR√ÅFICOS ---
        function renderPatients() {
            const q = document.getElementById('patientSearch').value.toLowerCase();
            document.getElementById('patientListBody').innerHTML = state.patients.filter(p => p.nombreCompleto.toLowerCase().includes(q)).map(p => `
                <tr onclick="switchView('details', {id:'${p.id}'})" style="cursor:pointer">
                    <td data-label="Paciente" style="color:var(--primary); font-weight:bold">${p.nombreCompleto}</td>
                    <td data-label="WhatsApp">${p.telefono}</td>
                    <td style="text-align:center;"><button class="btn btn-ghost" onclick="event.stopPropagation(); openEditPatient('${p.id}')">‚úèÔ∏è Editar</button></td>
                </tr>`).join('');
        }

        async function loadPatientDetails(id) {
            state.selPat = state.patients.find(x => x.id === id);
            document.getElementById('detName').innerText = state.selPat.nombreCompleto;
            document.getElementById('reportContainer').innerHTML = '';
            db.collection(getPath("pacientes")).doc(id).collection("mediciones").orderBy("fecha", "asc").onSnapshot(s => {
                state.measures = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderMeasuresList(); renderEvolutionCharts();
            });
        }

        function renderEvolutionCharts() {
            if (state.measures.length < 1) return;
            const l = state.measures.map(m => m.fecha.toDate().toLocaleDateString());
            drawChart('chartGeneral', 'Masa Magra vs Total', l, [
                { label: 'Peso Total', data: state.measures.map(m => m.resultados.pesoActual), color: '#7b2cbf' },
                { label: 'Masa Magra', data: state.measures.map(m => (m.resultados.pesoActual - (m.resultados.kilosGrasaTotal || 0))), color: '#2ecc71' }
            ]);
            drawChart('chartFat', '% Grasa', l, [{ label: '% Grasa', data: state.measures.map(m => m.resultados.tejidoGrasoPorcentaje), color: '#ef4444', fill: true }]);
            drawChart('chartPliegues', 'Pliegues (mm)', l, [
                { label: 'PT', data: state.measures.map(m => m.indicadores?.pt || 0), color: '#9d4edd' },
                { label: 'PSE', data: state.measures.map(m => m.indicadores?.pse || 0), color: '#3498db' }
            ]);
            drawChart('chartComparison', 'Progreso', l, [{ label: 'Peso', data: state.measures.map(m => m.resultados.pesoActual), color: '#7b2cbf' }]);
        }

        function drawChart(id, title, labels, datasets) {
            const ctx = document.getElementById(id).getContext('2d');
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: datasets.map(s => ({
                    label: s.label, data: s.data, borderColor: s.color, backgroundColor: s.color + '22',
                    fill: s.fill || false, tension: 0.3, pointRadius: 5
                })) },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderMeasuresList() {
            document.getElementById('measurementList').innerHTML = [...state.measures].reverse().map(m => `
                <div class="card" style="cursor:pointer" onclick="openEditMeasure('${m.id}')">
                    <div style="display:flex; justify-content:space-between"><strong>üìÖ ${m.fecha.toDate().toLocaleDateString()}</strong><span style="color:var(--primary); font-size:12px">Ver/Editar</span></div>
                    <div style="font-size:14px; margin-top:8px">Peso: ${m.resultados.pesoActual} kg | Grasa: ${m.resultados.tejidoGrasoPorcentaje.toFixed(1)}%</div>
                </div>`).join('');
        }

        function openEditMeasure(mid) {
            const m = state.measures.find(x => x.id === mid);
            document.getElementById('edit_m_id').value = mid;
            document.getElementById('m_w').value = m.resultados.pesoActual;
            document.getElementById('m_goal').value = m.objetivos?.pesoObjetivo || 0;
            document.getElementById('m_pt').value = m.indicadores?.pt || 0;
            document.getElementById('m_pse').value = m.indicadores?.pse || 0;
            document.getElementById('m_psi').value = m.indicadores?.psi || 0;
            document.getElementById('m_pa').value = m.indicadores?.pa || 0;
            document.getElementById('m_act').value = m.objetivos?.actividadTipo || 'moderado';
            document.getElementById('modalMeasure').classList.add('active');
        }

        // --- REPORTE ESTRELLA ---
        function generateSuccessReport() {
            if(state.measures.length < 2) return alert("Faltan datos.");
            let best = { month: '', loss: -999 };
            for(let i=1; i<state.measures.length; i++) {
                const loss = state.measures[i-1].resultados.kilosGrasaTotal - state.measures[i].resultados.kilosGrasaTotal;
                if(loss > best.loss) best = { month: state.measures[i].fecha.toDate().toLocaleString('es', {month:'long'}), loss };
            }
            document.getElementById('reportContainer').innerHTML = `<div class="best-month-card"><h3>üèÜ Mes Estrella: ${best.month.toUpperCase()}</h3><p>Perdiste ${best.loss.toFixed(2)} kg de grasa.</p></div>`;
        }

        // --- IA ---
        async function sendAIRequest() {
            const i = document.getElementById('chatInput'), b = document.getElementById('chatBox');
            const m = i.value; if(!m) return; i.value = '';
            b.innerHTML += `<div style="align-self:flex-end; background:var(--primary); color:white; padding:10px; border-radius:10px; max-width:80%;">${m}</div>`;
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`, { method: 'POST', body: JSON.stringify({contents:[{parts:[{text: m}]}]}) });
                const d = await r.json(); b.innerHTML += `<div style="align-self:flex-start; background:white; border:1px solid #ddd; padding:10px; border-radius:10px; max-width:80%;">${d.candidates[0].content.parts[0].text}</div>`;
                b.scrollTop = b.scrollHeight;
            } catch(e) { b.innerHTML += `<div>Error IA</div>`; }
        }

        // --- ASIGNACI√ìN DE FORMULARIOS (FIX TYPEERROR NULL) ---
        function initFormHandlers() {
            document.getElementById('formTurno').onsubmit = async (e) => {
                e.preventDefault();
                const time = document.getElementById('t_selected_time').value;
                if(!time) return alert("Selecciona horario.");
                showLoader(true);
                const data = { date: document.getElementById('t_date').value, time, paciente: document.getElementById('t_paciente').value, phone: document.getElementById('t_phone').value, obs: document.getElementById('t_obs').value };
                if(document.getElementById('t_id').value) await db.collection(getPath("turnos")).doc(document.getElementById('t_id').value).update(data);
                else await db.collection(getPath("turnos")).add(data);
                closeModals(); showLoader(false);
            };

            document.getElementById('formMeasure').onsubmit = async (e) => {
                e.preventDefault(); showLoader(true);
                const w = parseFloat(document.getElementById('m_w').value);
                const pt = parseFloat(document.getElementById('m_pt').value || 0), pse = parseFloat(document.getElementById('m_pse').value || 0);
                const fat = ((pt + pse) * 0.153) + 5.78;
                const data = {
                    resultados: { pesoActual: w, tejidoGrasoPorcentaje: fat, kilosGrasaTotal: (w * fat) / 100 },
                    indicadores: { pt, pse, psi: parseFloat(document.getElementById('m_psi').value), pa: parseFloat(document.getElementById('m_pa').value) },
                    objetivos: { pesoObjetivo: parseFloat(document.getElementById('m_goal').value), actividadTipo: document.getElementById('m_act').value }
                };
                const mid = document.getElementById('edit_m_id').value;
                if(mid) await db.collection(getPath("pacientes")).doc(state.selPat.id).collection("mediciones").doc(mid).update(data);
                else { data.fecha = firebase.firestore.Timestamp.now(); await db.collection(getPath("pacientes")).doc(state.selPat.id).collection("mediciones").add(data); }
                await db.collection(getPath("pacientes")).doc(state.selPat.id).update({ ultimoPeso: w });
                closeModals(); showLoader(false);
            };

            document.getElementById('formPatient').onsubmit = async (e) => {
                e.preventDefault(); showLoader(true);
                const d = { nombreCompleto: document.getElementById('p_name').value, telefono: document.getElementById('p_phone').value, fechaNacimiento: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('p_birth').value)), sexo: document.getElementById('p_gender').value, ultimoPeso: parseFloat(document.getElementById('p_weight').value) };
                const id = document.getElementById('edit_p_id').value;
                if(id) await db.collection(getPath("pacientes")).doc(id).update(d);
                else await db.collection(getPath("pacientes")).add(d);
                closeModals(); showLoader(false);
            };

            document.getElementById('formFood').onsubmit = async (e) => {
                e.preventDefault();
                await db.collection(getPath("alimentos")).add({ name: document.getElementById('f_n').value, protein: document.getElementById('f_p').value, carbs: document.getElementById('f_ca').value, fats: document.getElementById('f_g').value });
                closeModals();
            };
        }

        // --- HELPERS ---
        function showLoader(s) { document.getElementById('mainLoader').style.display = s ? 'flex' : 'none'; }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
        window.onclick = (e) => { if(e.target.className.includes('modal active')) closeModals(); };
        function sendWa(p, n, d, t) { window.open(`https://wa.me/${p}?text=${encodeURIComponent('Recordatorio: Turno Nutricionista '+d+' a las '+t+' hs.')}`, '_blank'); }
        function updateBadge() {
            const t = new Date(); const limit = new Date(); limit.setDate(t.getDate() + 3);
            const count = state.turnos.filter(x => { const d = new Date(x.date + 'T00:00:00'); return d >= t && d <= limit; }).length;
            const b = document.getElementById('notifBadge'); b.innerText = count; b.style.display = count > 0 ? 'block' : 'none';
        }
        function openPatientModal() { document.getElementById('formPatient').reset(); document.getElementById('edit_p_id').value = ''; document.getElementById('modalPatient').classList.add('active'); }
        function openEditPatient(id) {
            const p = state.patients.find(x => x.id === id);
            document.getElementById('edit_p_id').value = id;
            document.getElementById('p_name').value = p.nombreCompleto;
            document.getElementById('p_phone').value = p.telefono;
            document.getElementById('p_birth').value = p.fechaNacimiento?.toDate().toISOString().split('T')[0] || '';
            document.getElementById('p_gender').value = p.sexo || 'femenino';
            document.getElementById('p_weight').value = p.ultimoPeso || 0;
            document.getElementById('modalPatient').classList.add('active');
        }
        function updatePatientDatalist() { document.getElementById('patientsList').innerHTML = state.patients.map(p => `<option value="${p.nombreCompleto}">`).join(''); }
        function openFoodModal() { document.getElementById('formFood').reset(); document.getElementById('modalFood').classList.add('active'); }
        function renderFoods() {
            const q = document.getElementById('foodSearch').value.toLowerCase();
            document.getElementById('foodGrid').innerHTML = state.foods.filter(f => f.name.toLowerCase().includes(q)).map(f => `<div class="card"><strong>${f.name}</strong></div>`).join('');
        }
        async function deleteTurno() { if(confirm("¬øBorrar?")) { await db.collection(getPath("turnos")).doc(document.getElementById('t_id').value).delete(); closeModals(); } }
        async function exportEvolutionPDF() {
            const { jsPDF } = window.jspdf; const pdf = new jsPDF();
            pdf.text("Informe: " + state.selPat.nombreCompleto, 15, 20);
            const canvas = await html2canvas(document.querySelector('.evolution-charts-container'));
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 30, 190, 100);
            pdf.save("Reporte_Nutricional.pdf");
        }
        function generateSmartPlan() { alert("Calculando plan con IA..."); }
        function openMeasureModal() { document.getElementById('formMeasure').reset(); document.getElementById('edit_m_id').value = ''; document.getElementById('modalMeasure').classList.add('active'); }
    </script>
</body>
</html>
