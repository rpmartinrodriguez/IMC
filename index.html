<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriManager Pro - Violet Edition</title>
    
    <!-- Librer√≠as Externas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            /* Gama de Violetas y Purpuras */
            --primary: #7b2cbf;
            --primary-dark: #5a189a;
            --primary-light: #9d4edd;
            --secondary: #c77dff;
            --accent: #e0aaff;
            --success: #2ecc71;
            --danger: #ef4444;
            --dark: #240046;
            --light: #f3e8ff;
            --bg: #f8f4ff;
            --white: #ffffff;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(123, 44, 191, 0.15);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--bg); 
            color: var(--dark); 
            margin: 0; 
            padding: 0; 
            min-height: 100vh; 
        }

        /* --- NAVEGACI√ìN --- */
        header { 
            background: var(--white); 
            padding: 15px 20px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            box-shadow: 0 2px 10px rgba(123, 44, 191, 0.1); 
        }

        .hamburger { 
            background: none; 
            border: none; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            gap: 5px; 
            z-index: 2100; 
        }

        .hamburger span { 
            width: 25px; 
            height: 3px; 
            background: var(--primary); 
            border-radius: 3px; 
            transition: 0.3s; 
        }
        
        .nav-overlay { 
            position: fixed; 
            top: 0; 
            left: -100%; 
            width: 280px; 
            height: 100%; 
            background: var(--dark); 
            z-index: 2000; 
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            padding-top: 80px; 
            box-shadow: 10px 0 30px rgba(0,0,0,0.3); 
        }

        .nav-overlay.active { left: 0; }

        .nav-links { list-style: none; padding: 0; margin: 0; }
        .nav-links li a { 
            display: block; 
            padding: 18px 25px; 
            color: var(--accent); 
            text-decoration: none; 
            font-size: 1.1em; 
            border-left: 4px solid transparent; 
            transition: 0.3s; 
        }

        .nav-links li a:hover, .nav-links li a.active { 
            color: white; 
            background: rgba(255,255,255,0.05); 
            border-left-color: var(--secondary); 
        }

        /* --- CONTENIDO --- */
        main { 
            max-width: 1100px; 
            margin: 20px auto; 
            padding: 0 15px 100px 15px; 
        }

        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.4s ease; }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* --- COMPONENTES UI --- */
        .card { 
            background: var(--white); 
            padding: 20px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
            margin-bottom: 20px; 
            border: 1px solid #e9d5ff; 
        }

        .btn { 
            padding: 12px 20px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 14px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            transition: 0.2s; 
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-ghost { background: var(--light); color: var(--primary); }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-danger { background: var(--danger); color: white; }

        .input-field { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #e9d5ff; 
            border-radius: 8px; 
            font-size: 16px; 
            margin-bottom: 15px; 
            outline: none; 
        }

        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(123, 44, 191, 0.1); }
        
        /* --- CALENDARIO --- */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background: #e9d5ff; 
            border: 1px solid #e9d5ff; 
            border-radius: 8px; 
            overflow: hidden; 
        }

        .calendar-cell { 
            background: white; 
            min-height: 110px; 
            padding: 8px; 
            cursor: pointer; 
            position: relative; 
            transition: 0.2s; 
        }

        .calendar-cell:hover { background: #fdfaff; }
        .calendar-cell.today { background: #f3e8ff; border: 2px solid var(--primary-light); }
        
        .day-n { font-weight: bold; font-size: 14px; color: var(--primary); margin-bottom: 5px; display: block; }
        
        .turno-pill { 
            background: var(--primary); 
            color: white; 
            font-size: 10px; 
            padding: 3px 6px; 
            border-radius: 4px; 
            margin-bottom: 3px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }

        /* --- GRID DE HORARIOS --- */
        .time-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); 
            gap: 10px; 
            margin-bottom: 20px; 
        }

        .time-slot { 
            padding: 10px; 
            border-radius: 8px; 
            border: 2px solid #e9d5ff; 
            background: white; 
            color: var(--primary); 
            font-weight: bold; 
            text-align: center; 
            cursor: pointer; 
            font-size: 13px; 
            transition: 0.2s; 
        }

        .time-slot:hover:not(.taken) { background: var(--light); border-color: var(--primary); }
        .time-slot.selected { background: var(--primary); color: white; border-color: var(--primary-dark); transform: scale(1.05); }
        .time-slot.taken { background: #f1f1f1; color: #aaa; text-decoration: line-through; border-color: #eee; cursor: not-allowed; }

        /* --- MODALES --- */
        .modal { 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(36, 0, 70, 0.6); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 3000; 
            padding: 15px; 
            backdrop-filter: blur(4px); 
        }

        .modal.active { display: flex; }
        .modal-content { 
            background: white; 
            width: 100%; 
            max-width: 550px; 
            border-radius: 20px; 
            max-height: 90vh; 
            overflow-y: auto; 
            padding: 30px; 
            position: relative; 
            border-top: 8px solid var(--primary); 
        }
        .modal-large { max-width: 850px; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa; }

        /* --- DAY VIEW --- */
        .day-view-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            border: 1px solid #e9d5ff; 
            border-radius: 12px; 
            margin-bottom: 10px; 
            background: #faf5ff; 
        }

        /* --- TABLAS --- */
        .table-wrapper { overflow-x: auto; border-radius: var(--radius); border: 1px solid #e9d5ff; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8f4ff; padding: 15px; text-align: left; font-size: 13px; color: var(--primary); text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f3e8ff; }

        /* --- CHAT IA --- */
        .chat-box { height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 15px; background: #fdfaff; border-radius: 10px; }
        .msg { padding: 12px 18px; border-radius: 18px; max-width: 80%; line-height: 1.5; font-size: 14px; }
        .msg-u { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg-b { align-self: flex-start; background: white; border: 1px solid #e9d5ff; border-bottom-left-radius: 2px; }

        /* --- UTILIDADES --- */
        .fab { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            width: 65px; 
            height: 65px; 
            background: var(--primary); 
            color: white; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 28px; 
            box-shadow: 0 10px 25px rgba(123, 44, 191, 0.4); 
            cursor: pointer; 
            border: none; 
            z-index: 900; 
        }

        .loader-overlay { 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.9); 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
        }
        
        .spinner { 
            width: 45px; 
            height: 45px; 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid var(--primary); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        @media (max-width: 768px) {
            .calendar-cell { min-height: 85px; padding: 4px; }
            .day-n { font-size: 11px; }
            .turno-pill { font-size: 8px; }
            .time-grid { grid-template-columns: repeat(3, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="mainLoader" class="loader-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: 600; color: var(--primary);">NutriManager Pro...</p>
    </div>

    <!-- Men√∫ Lateral -->
    <nav id="navOverlay" class="nav-overlay">
        <ul class="nav-links">
            <li><a href="#" onclick="switchView('agenda')" id="link-agenda" class="active">üìÖ Agenda Nutricional</a></li>
            <li><a href="#" onclick="switchView('patients')" id="link-patients">üë• Mis Pacientes</a></li>
            <li><a href="#" onclick="switchView('foods')" id="link-foods">üçé Biblioteca Alimentos</a></li>
            <li><a href="#" onclick="switchView('calc')" id="link-calc">‚öñÔ∏è Calculadora IMC</a></li>
            <li><a href="#" onclick="switchView('ai')" id="link-ai">ü§ñ Asistente Virtual IA</a></li>
        </ul>
    </nav>

    <header>
        <button class="hamburger" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </button>
        <h2 id="viewHeaderTitle" style="margin:0; font-size: 1.1rem; color: var(--primary)">Mi Agenda</h2>
        <div style="font-size: 20px; cursor: pointer; color: var(--primary);" onclick="showUpcomingAlert()">üîî</div>
    </header>

    <main>
        <!-- VISTA: AGENDA (PRINCIPAL) -->
        <section id="view-agenda" class="view-section active">
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button class="btn btn-ghost" onclick="changeMonth(-1)">‚óÄ</button>
                    <h2 id="calendarLabel" style="margin:0; font-size: 1.2rem; color: var(--primary-dark)">Mes A√±o</h2>
                    <button class="btn btn-ghost" onclick="changeMonth(1)">‚ñ∂</button>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
        </section>

        <!-- VISTA: PACIENTES -->
        <section id="view-patients" class="view-section">
            <div class="card" style="display:flex; gap:10px;">
                <input type="search" id="patientSearch" class="input-field" style="margin:0" placeholder="üîç Buscar paciente..." oninput="renderPatients()">
                <button class="btn btn-primary" onclick="openPatientModal()">+</button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr><th>Paciente</th><th>WhatsApp</th><th>√öltimo Peso</th><th>Acciones</th></tr>
                    </thead>
                    <tbody id="patientListBody"></tbody>
                </table>
            </div>
        </section>

        <!-- VISTA: DETALLE / EVOLUCI√ìN -->
        <section id="view-details" class="view-section">
            <div style="display:flex; justify-content: space-between; margin-bottom: 20px;">
                <button class="btn btn-ghost" onclick="switchView('patients')">‚¨Ö Volver</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="generateSmartPlan()">‚ú® Generar Plan</button>
                    <button class="btn btn-ghost" onclick="exportEvolutionPDF()">üìÑ Exportar PDF</button>
                </div>
            </div>
            <div class="card">
                <h2 id="detName" style="margin-top:0">Nombre del Paciente</h2>
                <div class="charts-grid">
                    <div style="height: 220px;"><canvas id="chartWeight"></canvas></div>
                    <div style="height: 220px;"><canvas id="chartFat"></canvas></div>
                </div>
            </div>
            <h3>Historial de Evaluaciones</h3>
            <div id="measurementList"></div>
            <button class="fab" onclick="openMeasureModal()">+</button>
        </section>

        <!-- VISTA: ALIMENTOS -->
        <section id="view-foods" class="view-section">
            <div class="card" style="display:flex; gap:10px">
                <input type="search" id="foodSearch" class="input-field" style="margin:0" placeholder="üçé Buscar alimento..." oninput="renderFoods()">
                <button class="btn btn-primary" onclick="openFoodModal()">+</button>
            </div>
            <div id="foodGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px"></div>
        </section>

        <!-- VISTA: CALCULADORA -->
        <section id="view-calc" class="view-section">
            <div class="card" style="max-width: 500px; margin: 0 auto">
                <h2 style="color: var(--primary)">Calculadora Nutricional</h2>
                <label>Peso Actual (kg)</label><input type="number" id="calcW" class="input-field" placeholder="70">
                <label>Altura (cm)</label><input type="number" id="calcH" class="input-field" placeholder="175">
                <button class="btn btn-primary" style="width:100%" onclick="quickBMI()">Calcular IMC</button>
                <div id="bmiRes" class="card" style="display:none; margin-top:20px; text-align:center; background: var(--light); font-weight: bold; color: var(--primary-dark);"></div>
            </div>
        </section>

        <!-- VISTA: IA -->
        <section id="view-ai" class="view-section">
            <div class="card">
                <div id="chatWindow" class="chat-box">
                    <div class="msg msg-b">¬°Hola! Soy tu asistente nutricional inteligente. ¬øDeseas analizar un men√∫, calcular macros o necesitas una sugerencia para un paciente?</div>
                </div>
                <div style="display:flex; gap:10px; margin-top:15px">
                    <input type="text" id="chatInput" class="input-field" style="margin:0" placeholder="Escribe tu consulta aqu√≠..." onkeypress="if(event.key==='Enter') sendAIRequest()">
                    <button class="btn btn-primary" onclick="sendAIRequest()">‚û§</button>
                </div>
            </div>
        </section>
    </main>

    <!-- MODALES -->

    <!-- Modal Day View -->
    <div id="modalDayView" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">&times;</span>
            <h2 id="dayViewTitle" style="color: var(--primary); margin-top: 0;">Turnos del D√≠a</h2>
            <div id="dayTurnosList"></div>
            <button class="btn btn-primary" style="width:100%; margin-top:15px" id="btnAddTurnoToday">+ Agendar Nuevo Turno</button>
        </div>
    </div>

    <!-- Modal Formulario Turno (CUADRICULA DE TIEMPOS) -->
    <div id="modalTurnoForm" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">&times;</span>
            <h2 id="turnoFormTitle" style="color: var(--primary); margin-top: 0;">Agendar Turno</h2>
            <form id="formTurno">
                <input type="hidden" id="t_id">
                <input type="hidden" id="t_date">
                <input type="hidden" id="t_selected_time" required>
                
                <label>Paciente</label>
                <input type="text" id="t_paciente" class="input-field" list="patientsList" required placeholder="Escriba el nombre...">
                <datalist id="patientsList"></datalist>
                
                <label style="display:block; margin-bottom: 12px; font-weight: bold;">Horarios Disponibles:</label>
                <div id="timeGrid" class="time-grid"></div>
                
                <label>WhatsApp</label>
                <input type="tel" id="t_phone" class="input-field" placeholder="54911..." required>
                
                <label>Notas / Obra Social</label>
                <textarea id="t_obs" class="input-field" rows="2" style="width:100%; padding:10px;"></textarea>
                
                <div style="display:flex; gap:10px">
                    <button type="submit" class="btn btn-primary" style="flex:1">Guardar Turno</button>
                    <button type="button" id="btnDeleteTurno" class="btn btn-danger" style="display:none" onclick="deleteTurno()">Borrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Paciente -->
    <div id="modalPatient" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">&times;</span>
            <h2 id="pTitle" style="color: var(--primary); margin-top: 0;">Nuevo Paciente</h2>
            <form id="formPatient">
                <input type="hidden" id="edit_p_id">
                <label>Nombre y Apellido</label><input type="text" id="p_name" class="input-field" required>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div><label>Nacimiento</label><input type="date" id="p_birth" class="input-field" required></div>
                    <div><label>Sexo</label><select id="p_gender" class="input-field"><option value="femenino">Femenino</option><option value="masculino">Masculino</option></select></div>
                </div>
                <label>WhatsApp</label><input type="tel" id="p_phone" class="input-field" placeholder="54911..." required>
                <label>Peso Inicial (kg)</label><input type="number" id="p_weight" step="0.1" class="input-field" required>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar Ficha</button>
            </form>
        </div>
    </div>

    <!-- Modal Medici√≥n -->
    <div id="modalMeasure" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Nueva Evaluaci√≥n</h2>
            <form id="formMeasure">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div><label>Peso (kg)</label><input type="number" id="m_w" step="0.1" class="input-field" required></div>
                    <div><label>Meta (kg)</label><input type="number" id="m_goal" step="0.1" class="input-field" required></div>
                </div>
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:5px">
                    <div><label>PT</label><input type="number" id="m_pt" class="input-field" value="0"></div>
                    <div><label>PSE</label><input type="number" id="m_pse" class="input-field" value="0"></div>
                    <div><label>PSI</label><input type="number" id="m_psi" class="input-field" value="0"></div>
                    <div><label>PA</label><input type="number" id="m_pa" class="input-field" value="0"></div>
                </div>
                <label>Actividad F√≠sica</label>
                <select id="m_act" class="input-field">
                    <option value="sedentario">Sedentario</option>
                    <option value="ligero">Ligero (1-2 d√≠as)</option>
                    <option value="moderado">Moderado (3-5 d√≠as)</option>
                    <option value="fuerte">Fuerte (Atleta)</option>
                </select>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div><label>Sue√±o (hs)</label><input type="number" id="m_sleep" class="input-field" value="7"></div>
                    <div><label>Estr√©s (1-10)</label><input type="range" id="m_stress" min="1" max="10" value="5" style="width:100%"></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Registrar Evaluaci√≥n</button>
            </form>
        </div>
    </div>

    <!-- Modal Alimento -->
    <div id="modalFood" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">&times;</span>
            <h2 style="color: var(--primary); margin-top: 0;">Gestionar Alimento</h2>
            <form id="formFood">
                <input type="hidden" id="edit_f_id">
                <label>Nombre</label><input type="text" id="f_n" class="input-field" required>
                <label>Categor√≠a</label>
                <select id="f_c" class="input-field">
                    <option value="proteina">Prote√≠na</option>
                    <option value="carbohidrato">Carbohidrato</option>
                    <option value="grasa">Grasa</option>
                    <option value="verdura">Verdura / Fibra</option>
                </select>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px">
                    <div><label>Prot</label><input type="number" id="f_p" class="input-field" value="0" step="0.1"></div>
                    <div><label>Carb</label><input type="number" id="f_ca" class="input-field" value="0" step="0.1"></div>
                    <div><label>Grasa</label><input type="number" id="f_g" class="input-field" value="0" step="0.1"></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar Alimento</button>
            </form>
        </div>
    </div>

    <!-- Modal Plan Resultado -->
    <div id="modalPlan" class="modal"><div class="modal-content modal-large">
        <header style="display:flex; justify-content:space-between">
            <h2 style="color: var(--primary); margin-top: 0;">‚ú® Propuesta de Plan</h2>
            <button onclick="closeModals()" style="background:none; border:none; font-size:24px; cursor:pointer">&times;</button>
        </header>
        <div id="planDisplayArea" style="margin-top:20px"></div>
    </div></div>

    <script>
        // 1. CONFIGURACI√ìN FIREBASE (REGLAS 1 Y 3)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'nutrimanager-pro-master';
        const firebaseConfig = {
            apiKey: "AIzaSyASQiAEMuqx4jAP6q0a4kwHQHcQOYC_EcQ",
            authDomain: "medicion-imc.firebaseapp.com",
            projectId: "medicion-imc",
            storageBucket: "medicion-imc.appspot.com",
            messagingSenderId: "544674177518",
            appId: "1:544674177518:web:c060519e65a2913e0beeff"
        };
        const getPath = (col) => `artifacts/${appId}/public/data/${col}`;

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let state = {
            view: 'agenda',
            patients: [],
            turnos: [],
            foods: [],
            measures: [],
            selPat: null,
            calDate: new Date(),
            user: null
        };

        // 2. INICIALIZACI√ìN (REGLA 3)
        document.addEventListener('DOMContentLoaded', async () => {
            showLoader(true);
            try {
                // Autenticar antes de cargar datos
                await auth.signInAnonymously();
                auth.onAuthStateChanged(user => {
                    if (user) {
                        state.user = user;
                        startRealtimeListeners();
                    }
                });
            } catch (e) { console.error("Error Auth:", e); showLoader(false); }
        });

        function startRealtimeListeners() {
            // Escuchar Pacientes
            db.collection(getPath("pacientes")).orderBy("nombreCompleto").onSnapshot(s => {
                state.patients = s.docs.map(d => ({id: d.id, ...d.data()}));
                updatePatientDatalist();
                if(state.view === 'patients') renderPatients();
            });

            // Escuchar Turnos
            db.collection(getPath("turnos")).onSnapshot(s => {
                state.turnos = s.docs.map(d => ({id: d.id, ...d.data()}));
                if(state.view === 'agenda') renderCalendar();
            });

            // Escuchar Alimentos
            db.collection(getPath("alimentos")).orderBy("name").onSnapshot(s => {
                state.foods = s.docs.map(d => ({id: d.id, ...d.data()}));
                if(state.view === 'foods') renderFoods();
            });

            showLoader(false);
        }

        // 3. NAVEGACI√ìN
        function toggleMenu() { document.getElementById('navOverlay').classList.toggle('active'); }
        
        function switchView(view, params = {}) {
            state.view = view;
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            
            document.getElementById(`view-${view}`).classList.add('active');
            const link = document.getElementById(`link-${view === 'details' ? 'patients' : view}`);
            if (link) link.classList.add('active');

            const headers = { agenda: 'Mi Agenda', patients: 'Mis Pacientes', details: 'Evoluci√≥n Paciente', foods: 'Biblioteca Alimentos', calc: 'Calculadora IMC', ai: 'Asistente IA' };
            document.getElementById('viewHeaderTitle').innerText = headers[view] || 'NutriManager';

            if (view === 'agenda') renderCalendar();
            if (view === 'patients') renderPatients();
            if (view === 'foods') renderFoods();
            if (view === 'details') loadPatientDetails(params.id);

            if (document.getElementById('navOverlay').classList.contains('active')) toggleMenu();
            window.scrollTo(0,0);
        }

        // 4. M√ìDULO CALENDARIO (AGENDA)
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const year = state.calDate.getFullYear(), month = state.calDate.getMonth();
            const first = new Date(year, month, 1).getDay();
            const days = new Date(year, month + 1, 0).getDate();
            const names = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            document.getElementById('calendarLabel').innerText = `${names[month]} ${year}`;

            // Labels de d√≠as
            ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'].forEach(d => {
                const el = document.createElement('div'); el.style.textAlign='center'; el.style.padding='10px'; el.style.fontWeight='bold'; el.style.color='var(--primary)'; el.style.fontSize='12px'; el.innerText=d; grid.appendChild(el);
            });

            for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));

            for(let d=1; d<=days; d++) {
                const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';
                if (ds === new Date().toISOString().split('T')[0]) cell.classList.add('today');
                
                cell.innerHTML = `<span class="day-n">${d}</span>`;
                
                const dTurnos = state.turnos.filter(t => t.date === ds).sort((a,b) => a.time.localeCompare(b.time));
                dTurnos.slice(0, 3).forEach(t => {
                    const p = document.createElement('div');
                    p.className = 'turno-pill';
                    p.innerText = `${t.time} ${t.paciente}`;
                    cell.appendChild(p);
                });
                if(dTurnos.length > 3) {
                    const more = document.createElement('div');
                    more.className = 'turno-pill';
                    more.style.background = '#94a3b8';
                    more.innerText = `+${dTurnos.length-3} m√°s...`;
                    cell.appendChild(more);
                }

                cell.onclick = () => openDayView(ds);
                grid.appendChild(cell);
            }
        }

        function changeMonth(dir) { state.calDate.setMonth(state.calDate.getMonth() + dir); renderCalendar(); }

        // VISOR DEL D√çA
        function openDayView(date) {
            const dTurnos = state.turnos.filter(t => t.date === date).sort((a,b) => a.time.localeCompare(b.time));
            document.getElementById('dayViewTitle').innerText = `D√≠a: ${date}`;
            const list = document.getElementById('dayTurnosList');
            list.innerHTML = dTurnos.length ? '' : '<p style="text-align:center; color:#aaa; padding:20px;">Sin compromisos para hoy.</p>';
            
            dTurnos.forEach(t => {
                const item = document.createElement('div');
                item.className = 'day-view-item';
                item.innerHTML = `
                    <div class="item-info">
                        <strong>${t.time} hs - ${t.paciente}</strong>
                        <br><small>${t.obs || 'Sin notas'}</small>
                    </div>
                    <div style="display:flex; gap:8px">
                        <button class="btn btn-whatsapp" onclick="sendWaReminder('${t.phone}', '${t.paciente}', '${t.date}', '${t.time}')">üì±</button>
                        <button class="btn btn-ghost" onclick="openTurnoForm('${date}', '${t.id}')">‚úèÔ∏è</button>
                    </div>`;
                list.appendChild(item);
            });

            document.getElementById('btnAddTurnoToday').onclick = () => openTurnoForm(date);
            document.getElementById('modalDayView').classList.add('active');
        }

        // FORMULARIO TURNO + CUADRICULA DE TIEMPOS
        function openTurnoForm(date, id = null) {
            const f = document.getElementById('formTurno');
            f.reset();
            document.getElementById('t_id').value = id || '';
            document.getElementById('t_date').value = date;
            document.getElementById('t_selected_time').value = '';
            document.getElementById('btnDeleteTurno').style.display = id ? 'block' : 'none';
            document.getElementById('turnoFormTitle').innerText = id ? 'Editar Turno' : `Turno: ${date}`;

            const grid = document.getElementById('timeGrid');
            grid.innerHTML = '';
            const taken = state.turnos.filter(t => t.date === date && t.id !== id).map(t => t.time);
            
            // Generar horas de 7 a 20
            for(let h=7; h<=20; h++) {
                ['00', '30'].forEach(m => {
                    const time = `${String(h).padStart(2,'0')}:${m}`;
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    if (taken.includes(time)) {
                        slot.classList.add('taken');
                    } else {
                        slot.onclick = () => {
                            document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                            slot.classList.add('selected');
                            document.getElementById('t_selected_time').value = time;
                        };
                    }
                    slot.innerText = time;
                    grid.appendChild(slot);
                });
            }

            if (id) {
                const t = state.turnos.find(x => x.id === id);
                document.getElementById('t_paciente').value = t.paciente;
                document.getElementById('t_phone').value = t.phone;
                document.getElementById('t_obs').value = t.obs;
                // Pre-seleccionar
                setTimeout(() => {
                    const slots = document.querySelectorAll('.time-slot');
                    slots.forEach(s => { if(s.innerText === t.time) { s.click(); } });
                }, 50);
            }

            document.getElementById('modalTurnoForm').classList.add('active');
        }

        document.getElementById('formTurno').onsubmit = async (e) => {
            e.preventDefault();
            const time = document.getElementById('t_selected_time').value;
            if(!time) return alert("Por favor, selecciona un horario de la cuadr√≠cula.");
            
            showLoader(true);
            const data = {
                date: document.getElementById('t_date').value,
                time: time,
                paciente: document.getElementById('t_paciente').value,
                phone: document.getElementById('t_phone').value,
                obs: document.getElementById('t_obs').value
            };
            const id = document.getElementById('t_id').value;
            if(id) await db.collection(getPath("turnos")).doc(id).update(data);
            else await db.collection(getPath("turnos")).add(data);
            
            closeModals();
            showLoader(false);
        };

        // 5. M√ìDULO PACIENTES
        function renderPatients() {
            const q = document.getElementById('patientSearch').value.toLowerCase();
            const filtered = state.patients.filter(p => p.nombreCompleto.toLowerCase().includes(q));
            const body = document.getElementById('patientListBody');
            body.innerHTML = filtered.map(p => `
                <tr onclick="switchView('details', {id:'${p.id}'})" style="cursor:pointer">
                    <td style="color:var(--primary); font-weight:bold">${p.nombreCompleto}</td>
                    <td>${p.telefono}</td>
                    <td>${p.ultimoPeso || '-'} kg</td>
                    <td>
                        <button class="btn btn-ghost" style="padding:6px 10px" onclick="event.stopPropagation(); openEditPatient('${p.id}')">‚úèÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function updatePatientDatalist() {
            document.getElementById('patientsList').innerHTML = state.patients.map(p => `<option value="${p.nombreCompleto}">`).join('');
        }

        // DETALLES PACIENTE & MEDICIONES
        async function loadPatientDetails(id) {
            state.selPat = state.patients.find(x => x.id === id);
            document.getElementById('detName').innerText = state.selPat.nombreCompleto;
            
            db.collection(getPath("pacientes")).doc(id).collection("mediciones").orderBy("fecha", "asc").onSnapshot(s => {
                state.measures = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderMeasures();
                renderEvolutionCharts();
            });
        }

        function renderMeasures() {
            const list = document.getElementById('measurementList');
            list.innerHTML = [...state.measures].reverse().map(m => `
                <div class="card" style="cursor:pointer" onclick="viewSavedPlan('${m.id}')">
                    <div style="display:flex; justify-content:space-between">
                        <strong>üìÖ ${m.fecha.toDate().toLocaleDateString()}</strong>
                        <span style="font-size:12px; color:var(--primary)">${m.plan ? '‚ú® Plan generado' : 'Ver datos'}</span>
                    </div>
                    <div style="font-size:14px; margin-top:10px; display:grid; grid-template-columns: 1fr 1fr">
                        <span>Peso: <b>${m.resultados.pesoActual} kg</b></span>
                        <span>Grasa: <b>${m.resultados.tejidoGrasoPorcentaje.toFixed(1)}%</b></span>
                    </div>
                </div>
            `).join('');
        }

        // GR√ÅFICOS
        let wChart, fChart;
        function renderEvolutionCharts() {
            if (state.measures.length < 2) return;
            const labels = state.measures.map(m => m.fecha.toDate().toLocaleDateString());
            const wData = state.measures.map(m => m.resultados.pesoActual);
            const fData = state.measures.map(m => m.resultados.tejidoGrasoPorcentaje);

            if(wChart) wChart.destroy();
            wChart = new Chart(document.getElementById('chartWeight'), {
                type:'line', data:{labels, datasets:[{label:'Peso (kg)', data:wData, borderColor:'#7b2cbf', tension:0.3, fill:true, backgroundColor:'rgba(123, 44, 191, 0.1)'}]},
                options:{responsive:true, maintainAspectRatio:false}
            });

            if(fChart) fChart.destroy();
            fChart = new Chart(document.getElementById('chartFat'), {
                type:'line', data:{labels, datasets:[{label:'Grasa (%)', data:fData, borderColor:'#ef4444', tension:0.3}]},
                options:{responsive:true, maintainAspectRatio:false}
            });
        }

        // 6. PLAN INTELIGENTE (ALGORITMO)
        async function generateSmartPlan() {
            if (state.measures.length === 0) return alert("Falta registrar una medici√≥n actual.");
            showLoader(true);
            const last = state.measures[state.measures.length-1];
            const p = state.selPat;
            const hoy = new Date(), nac = p.fechaNacimiento.toDate();
            let edad = hoy.getFullYear() - nac.getFullYear();

            // Mifflin-St Jeor
            let bmr = (10 * last.resultados.pesoActual) + (6.25 * 170) - (5 * edad) + (p.sexo==='masculino'?5:-161);
            const factor = { sedentario:1.2, ligero:1.375, moderado:1.55, fuerte:1.725 }[last.objetivos.actividadTipo] || 1.375;
            let target = last.objetivos.pesoObjetivo < last.resultados.pesoActual ? (bmr*factor)-500 : (bmr*factor)+300;

            const prots = state.foods.filter(f => f.category==='proteina').sort(() => 0.5 - Math.random());
            const carbs = state.foods.filter(f => f.category==='carbohidrato').sort(() => 0.5 - Math.random());

            const html = `
                <div class="card" style="border-left:5px solid var(--primary)">
                    <h3>Requerimiento: ${Math.round(target)} kcal/d√≠a</h3>
                    <p><b>P:</b> ${Math.round(target*0.3/4)}g | <b>C:</b> ${Math.round(target*0.4/4)}g | <b>G:</b> ${Math.round(target*0.3/9)}g</p>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
                    <div class="card"><h4>üåÖ Desayuno</h4><ul><li>100g ${prots[0]?.name||'Prote√≠na'}</li><li>60g ${carbs[0]?.name||'Carbs'}</li></ul></div>
                    <div class="card"><h4>ü•ó Almuerzo</h4><ul><li>150g ${prots[1]?.name||'Prote√≠na'}</li><li>100g ${carbs[1]?.name||'Carbs'}</li></ul></div>
                </div>
                <div class="card" style="background:#fff9db; border-color:#ffe066">
                    <h4>üèÉ Recomendaci√≥n Actividad</h4>
                    <p>${last.objetivos.actividadTipo === 'sedentario' ? 'Caminatas diarias de 30 min a paso moderado.' : 'Entrenamiento de fuerza 45 min + cardio ligero.'}</p>
                </div>
            `;
            document.getElementById('planDisplayArea').innerHTML = html;
            document.getElementById('modalPlan').classList.add('active');
            await db.collection(getPath("pacientes")).doc(p.id).collection("mediciones").doc(last.id).update({ plan: html });
            showLoader(false);
        }

        // 7. IA GEMINI (ASISTENTE)
        async function sendAIRequest() {
            const inp = document.getElementById('chatInput'), win = document.getElementById('chatWindow');
            if(!inp.value.trim()) return;
            const msg = inp.value; inp.value = '';
            win.innerHTML += `<div class="msg msg-u">${msg}</div>`;
            win.scrollTop = win.scrollHeight;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`, {
                    method: 'POST', body: JSON.stringify({contents:[{parts:[{text: `Eres un nutricionista experto. El usuario pregunta: ${msg}`}]}]})
                });
                const data = await res.json();
                win.innerHTML += `<div class="msg msg-b">${data.candidates[0].content.parts[0].text}</div>`;
                win.scrollTop = win.scrollHeight;
            } catch(e) { win.innerHTML += `<div class="msg msg-b" style="color:red">Error al conectar con el cerebro IA.</div>`; }
        }

        // 8. CRUD & HELPERS
        function showLoader(s) { document.getElementById('mainLoader').style.display = s ? 'flex' : 'none'; }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
        window.onclick = (e) => { if(e.target.className === 'modal active') closeModals(); };

        function openPatientModal() { 
            document.getElementById('formPatient').reset(); 
            document.getElementById('edit_p_id').value = ''; 
            document.getElementById('pTitle').innerText = 'Nuevo Paciente';
            document.getElementById('modalPatient').classList.add('active'); 
        }

        function openEditPatient(id) {
            const p = state.patients.find(x => x.id === id);
            document.getElementById('edit_p_id').value = id;
            document.getElementById('p_name').value = p.nombreCompleto;
            document.getElementById('p_phone').value = p.telefono;
            document.getElementById('p_weight').value = p.ultimoPeso;
            document.getElementById('p_gender').value = p.sexo;
            document.getElementById('p_birth').value = p.fechaNacimiento.toDate().toISOString().split('T')[0];
            document.getElementById('pTitle').innerText = 'Editar Paciente';
            document.getElementById('modalPatient').classList.add('active');
        }

        document.getElementById('formPatient').onsubmit = async (e) => {
            e.preventDefault();
            showLoader(true);
            const id = document.getElementById('edit_p_id').value;
            const data = {
                nombreCompleto: document.getElementById('p_name').value,
                telefono: document.getElementById('p_phone').value,
                ultimoPeso: parseFloat(document.getElementById('p_weight').value),
                sexo: document.getElementById('p_gender').value,
                fechaNacimiento: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('p_birth').value)),
                fechaUltimoRegistro: firebase.firestore.Timestamp.now()
            };
            if(id) await db.collection(getPath("pacientes")).doc(id).update(data);
            else await db.collection(getPath("pacientes")).add(data);
            closeModals();
            showLoader(false);
        };

        function openMeasureModal() { document.getElementById('formMeasure').reset(); document.getElementById('modalMeasure').classList.add('active'); }
        document.getElementById('formMeasure').onsubmit = async (e) => {
            e.preventDefault();
            showLoader(true);
            const w = parseFloat(document.getElementById('m_w').value);
            const pt = parseFloat(document.getElementById('m_pt').value || 0);
            const pse = parseFloat(document.getElementById('m_pse').value || 0);
            const fat = ((pt + pse) * 0.15) + 5.7; // Simplificado

            const d = {
                fecha: firebase.firestore.Timestamp.now(),
                objetivos: { pesoObjetivo: parseFloat(document.getElementById('m_goal').value), actividadTipo: document.getElementById('m_act').value },
                resultados: { pesoActual: w, tejidoGrasoPorcentaje: fat }
            };
            await db.collection(getPath("pacientes")).doc(state.selPat.id).collection("mediciones").add(d);
            await db.collection(getPath("pacientes")).doc(state.selPat.id).update({ ultimoPeso: w, fechaUltimoRegistro: d.fecha });
            closeModals();
            showLoader(false);
        };

        function openFoodModal() { document.getElementById('formFood').reset(); document.getElementById('modalFood').classList.add('active'); }
        document.getElementById('formFood').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('f_n').value, category: document.getElementById('f_c').value,
                protein: parseFloat(document.getElementById('f_p').value), carbs: parseFloat(document.getElementById('f_ca').value), fats: parseFloat(document.getElementById('f_g').value)
            };
            await db.collection(getPath("alimentos")).add(data);
            closeModals();
        };

        function renderFoods() {
            const q = document.getElementById('foodSearch').value.toLowerCase();
            document.getElementById('foodGrid').innerHTML = state.foods.filter(f => f.name.toLowerCase().includes(q)).map(f => `
                <div class="card">
                    <strong>${f.name}</strong><br><small>${f.category}</small>
                    <div style="font-size:12px; margin-top:8px">P: ${f.protein} | C: ${f.carbs} | G: ${f.fats}</div>
                </div>
            `).join('');
        }

        async function deleteTurno() {
            if(confirm("¬øEliminar este turno definitivamente?")) {
                await db.collection(getPath("turnos")).doc(document.getElementById('t_id').value).delete();
                closeModals();
            }
        }

        function sendWaReminder(ph, n, d, t) {
            const m = encodeURIComponent(`Hola ${n}, te recuerdo tu turno el ${d} a las ${t} hs. ¬°Saludos!`);
            window.open(`https://wa.me/${ph}?text=${m}`, '_blank');
        }

        function quickBMI() {
            const w = parseFloat(document.getElementById('calcW').value), h = parseFloat(document.getElementById('calcH').value)/100;
            if(!w || !h) return;
            const r = (w/(h*h)).toFixed(1);
            let cat = r < 18.5 ? "Bajo peso" : r < 25 ? "Normal" : r < 30 ? "Sobrepeso" : "Obesidad";
            document.getElementById('bmiRes').innerHTML = `IMC: ${r} - ${cat}`;
            document.getElementById('bmiRes').style.display = 'block';
        }

        async function exportEvolutionPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            const p = state.selPat;
            pdf.text(p.nombreCompleto, 15, 20);
            pdf.autoTable({
                startY: 30, head: [['Fecha', 'Peso (kg)', '% Grasa']],
                body: state.measures.map(m => [m.fecha.toDate().toLocaleDateString(), m.resultados.pesoActual, m.resultados.tejidoGrasoPorcentaje.toFixed(1)])
            });
            pdf.save(`Informe_${p.nombreCompleto}.pdf`);
        }

        function viewSavedPlan(mid) {
            const m = state.measures.find(x => x.id === mid);
            if(m && m.plan) {
                document.getElementById('planDisplayArea').innerHTML = m.plan;
                document.getElementById('modalPlan').classList.add('active');
            }
        }

        function showUpcomingAlert() {
            const today = new Date().toISOString().split('T')[0];
            const up = state.turnos.filter(x => x.date >= today).sort((a,b) => a.date.localeCompare(b.date));
            if(!up.length) return alert("No hay turnos pr√≥ximos.");
            alert("Pr√≥ximos Turnos:\n" + up.slice(0,3).map(x => `- ${x.date} ${x.time}: ${x.paciente}`).join('\n'));
        }
    </script>
</body>
</html>
