<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Paciente</title>
    <link rel="stylesheet" href="style.css">
    <!-- LIBRERÍAS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

    <!-- Menú de Navegación -->
    <div id="navigation-overlay" class="navigation-overlay">
        <button id="close-nav-button" class="close-nav-button">&times;</button>
        <ul class="nav-links">
            <li><a href="index.html">Pacientes</a></li>
            <li><a href="menus.html">Menús</a></li>
            <li><a href="alimentos.html">Alimentos</a></li>
            <li><a href="ejercicios.html">Ejercicios</a></li>
            <li><a href="calculadora.html">Calculadora IMC</a></li>
        </ul>
    </div>

    <div class="container">
        <header>
            <button id="hamburger-button" class="hamburger-button">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>
            <h1 id="patientName">Cargando paciente...</h1>
            <div class="header-actions">
                <button id="generatePlanBtn" class="btn-primary">Generar Plan Inteligente</button>
                <button id="exportPdfBtn" class="btn-secondary">Exportar a PDF</button>
            </div>
        </header>

        <!-- Gráficos -->
        <div id="chartsSection" class="charts-container" style="display: none;">
            <div class="chart-wrapper">
                <h3>Variación de Peso y Masa Magra (kg)</h3>
                <canvas id="weightChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <h3>Porcentaje de Grasa Corporal (%)</h3>
                <canvas id="fatPercentageChart"></canvas>
            </div>
        </div>

        <!-- Historial -->
        <div class="historial-container">
            <h2>Historial de Mediciones</h2>
            <div id="measurementHistoryList"></div>
        </div>

        <button id="addMeasurementBtn" class="fab">+</button>
    </div>

    <!-- MODAL PARA AÑADIR/EDITAR MEDICIÓN -->
    <div id="addMeasurementModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="measurementModalTitle">Registrar Nueva Medición</h2>
            <form id="addMeasurementForm">
                <input type="hidden" id="measurementId">
                <fieldset>
                    <legend>Medición Actual</legend>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fecha">Fecha de la Medición</label>
                            <input type="date" id="fecha" class="input-field" required>
                        </div>
                        <div class="form-group">
                            <label for="pesoAnterior">Peso Anterior (kg)</label>
                            <input type="number" id="pesoAnterior" class="input-field" disabled>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pesoActual">Peso Actual (kg)</label>
                            <input type="number" id="pesoActual" step="0.1" class="input-field" required>
                        </div>
                        <div class="form-group">
                            <label>Resultado</label>
                            <p id="diferenciaPeso" class="result-display">-</p>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Indicadores (Pliegues)</legend>
                    <div class="form-row">
                        <div class="form-group"><label for="pt">PT</label><input type="number" id="pt" class="indicator-input" step="0.1" required></div>
                        <div class="form-group"><label for="pse">PSE</label><input type="number" id="pse" class="indicator-input" step="0.1" required></div>
                        <div class="form-group"><label for="psi">PSI</label><input type="number" id="psi" class="indicator-input" step="0.1" required></div>
                        <div class="form-group"><label for="pa">PA</label><input type="number" id="pa" class="indicator-input" step="0.1" required></div>
                    </div>
                    <div class="form-group"><label>Tejido Graso (%)</label><p id="tejidoGraso" class="result-display">-</p></div>
                </fieldset>
                <fieldset>
                    <legend>Objetivos y Estilo de Vida</legend>
                    <div class="form-row">
                        <div class="form-group"><label for="pesoObjetivo">Peso Objetivo (kg)</label><input type="number" id="pesoObjetivo" step="0.1" class="input-field" required></div>
                        <div class="form-group"><label for="actividadTipo">Tipo de Actividad Física</label><select id="actividadTipo" class="input-field" required><option value="sedentario">Sedentario</option><option value="ligero">Ligero</option><option value="moderado">Moderado</option><option value="fuerte">Fuerte</option><option value="muy-fuerte">Muy Fuerte</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="actividadDuracion">Duración por Sesión (min)</label><input type="number" id="actividadDuracion" class="input-field" required></div>
                        <div class="form-group"><label for="horasSueno">Horas de Sueño (promedio)</label><input type="number" id="horasSueno" step="0.5" class="input-field" required></div>
                    </div>
                    <div class="form-group"><label for="nivelEstres">Nivel de Estrés (1 al 10)</label><input type="range" id="nivelEstres" min="1" max="10" value="5" class="input-range"><span id="nivelEstresValor">5</span></div>
                </fieldset>
                <button type="submit" class="btn-guardar">Guardar</button>
            </form>
        </div>
    </div>
    
    <!-- MODAL PARA VER MEDICIÓN GUARDADA -->
    <div id="viewMeasurementModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="viewModalTitle">Detalle de Medición</h2>
            <fieldset><legend>Análisis de Peso</legend><div class="data-grid"><div class="data-item"><strong>Peso Anterior:</strong> <span id="viewPesoAnterior"></span></div><div class="data-item"><strong>Peso Actual:</strong> <span id="viewPesoActual"></span></div><div class="data-item"><strong>Diferencia:</strong> <span id="viewDiferenciaPeso"></span></div></div></fieldset>
            <fieldset><legend>Indicadores (Pliegues)</legend><div class="data-grid"><div class="data-item"><strong>PT:</strong> <span id="viewPT"></span></div><div class="data-item"><strong>PSE:</strong> <span id="viewPSE"></span></div><div class="data-item"><strong>PSI:</strong> <span id="viewPSI"></span></div><div class="data-item"><strong>PA:</strong> <span id="viewPA"></span></div></div></fieldset>
            <fieldset><legend>Resultados Calculados</legend><div class="data-grid"><div class="data-item"><strong>% Tejido Graso:</strong> <span id="viewTejidoGraso"></span></div><div class="data-item"><strong>Kilos de Grasa:</strong> <span id="viewKilosGrasa"></span></div><div class="data-item"><strong>Cambio Grasa:</strong> <span id="viewCambioGrasa"></span></div><div class="data-item"><strong>Cambio Masa Magra:</strong> <span id="viewCambioMasaMagra"></span></div></div></fieldset>
            <fieldset><legend>Objetivos y Estilo de Vida Registrados</legend><div class="data-grid"><div class="data-item"><strong>Peso Objetivo:</strong> <span id="viewPesoObjetivo"></span></div><div class="data-item"><strong>Actividad Física:</strong> <span id="viewActividadTipo"></span></div><div class="data-item"><strong>Duración Sesión:</strong> <span id="viewActividadDuracion"></span></div><div class="data-item"><strong>Horas de Sueño:</strong> <span id="viewHorasSueno"></span></div><div class="data-item"><strong>Nivel de Estrés:</strong> <span id="viewNivelEstres"></span></div></div></fieldset>
            <div id="viewSavedPlanContainer" style="display:none;">
                <button id="viewSavedPlanBtn" class="btn-primary full-width">Ver Plan Inteligente Guardado</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA OPCIONES DE EXPORTACIÓN A PDF -->
    <div id="exportPdfModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Opciones de Exportación a PDF</h2>
            <form id="exportOptionsForm">
                <p>El informe incluirá los gráficos de evolución, las últimas 5 mediciones y el plan inteligente más reciente.</p>
                <div class="form-group-checkbox"><input type="checkbox" id="includeMenuCheck"><label for="includeMenuCheck">Adjuntar un menú manual adicional</label></div>
                <div id="menuSelectionContainer" class="form-group" style="display: none;"><label for="menuSelect">Selecciona un menú</label><select id="menuSelect" class="input-field"></select></div>
                <button type="submit" class="btn-guardar">Generar PDF</button>
            </form>
        </div>
    </div>
    
    <!-- MODAL PARA MOSTRAR EL PLAN GENERADO -->
    <div id="planResultModal" class="modal">
        <div class="modal-content large">
            <span class="close-btn">&times;</span>
            <h2>Plan Inteligente Sugerido</h2>
            <div class="tabs">
                <button class="tab-link active" data-tab="plan-interpretacion">Análisis de Evolución</button>
                <button class="tab-link" data-tab="plan-alimentacion">Plan de Alimentación</button>
                <button class="tab-link" data-tab="plan-ejercicio">Recomendaciones</button>
            </div>
            <div id="plan-interpretacion" class="tab-content active"></div>
            <div id="plan-alimentacion" class="tab-content"></div>
            <div id="plan-ejercicio" class="tab-content"></div>
        </div>
    </div>

    <!-- OVERLAY DE CARGA -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;"><div class="spinner"></div><p id="loading-text">Generando PDF, por favor espera...</p></div>

    <!-- SDKs de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    
    <!-- Scripts de la página -->
    <script src="mediciones.js"></script>
    <script src="main.js"></script>
</body>
</html>
