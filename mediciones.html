<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Paciente</title>
    <link rel="stylesheet" href="style.css">
    <!-- LIBRERÍAS PARA GRÁFICOS Y PDF -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

    <!-- Menú de Navegación Desplegable -->
    <div id="navigation-overlay" class="navigation-overlay">
        <button id="close-nav-button" class="close-nav-button">&times;</button>
        <ul class="nav-links">
            <li><a href="index.html">Pacientes</a></li>
            <li><a href="menus.html">Menús</a></li>
            <li><a href="calculadora.html">Calculadora IMC</a></li>
        </ul>
    </div>

    <div class="container">
        <header>
            <!-- Botón de Hamburguesa -->
            <button id="hamburger-button" class="hamburger-button">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>
            <h1 id="patientName">Cargando paciente...</h1>
            <div class="header-actions">
                <button id="exportPdfBtn" class="btn-secondary">Exportar a PDF</button>
            </div>
        </header>

        <!-- SECCIÓN PARA LOS GRÁFICOS -->
        <div id="chartsSection" class="charts-container" style="display: none;">
            <div class="chart-wrapper">
                <h3>Variación de Peso y Masa Magra (kg)</h3>
                <canvas id="weightChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <h3>Porcentaje de Grasa Corporal (%)</h3>
                <canvas id="fatPercentageChart"></canvas>
            </div>
        </div>

        <!-- Historial de mediciones del paciente -->
        <div class="historial-container">
            <h2>Historial de Mediciones</h2>
            <div id="measurementHistoryList"></div>
        </div>

        <button id="addMeasurementBtn" class="fab">+</button>
    </div>

    <!-- MODAL PARA AÑADIR NUEVA MEDICIÓN -->
    <div id="addMeasurementModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Registrar Nueva Medición</h2>
            <form id="addMeasurementForm">
                <fieldset>
                    <legend>Análisis de Peso</legend>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fecha">Fecha Actual</label>
                            <input type="text" id="fecha" disabled>
                        </div>
                        <div class="form-group">
                            <label for="pesoAnterior">Peso Anterior (kg)</label>
                            <input type="number" id="pesoAnterior" disabled>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pesoActual">Peso Actual (kg)</label>
                            <input type="number" id="pesoActual" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Resultado</label>
                            <p id="diferenciaPeso" class="result-display">-</p>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Indicadores (Pliegues)</legend>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pt">PT</label>
                            <input type="number" id="pt" class="indicator-input" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="pse">PSE</label>
                            <input type="number" id="pse" class="indicator-input" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="psi">PSI</label>
                            <input type="number" id="psi" class="indicator-input" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="pa">PA</label>
                            <input type="number" id="pa" class="indicator-input" step="0.1" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tejido Graso (%)</label>
                        <p id="tejidoGraso" class="result-display">-</p>
                    </div>
                </fieldset>
                <button type="submit" class="btn-guardar">Guardar Medición</button>
            </form>
        </div>
    </div>
    
    <!-- MODAL PARA VER MEDICIÓN GUARDADA -->
    <div id="viewMeasurementModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="viewModalTitle">Detalle de Medición</h2>
            <fieldset>
                <legend>Análisis de Peso</legend>
                <div class="data-grid">
                    <div class="data-item"><strong>Peso Anterior:</strong> <span id="viewPesoAnterior"></span></div>
                    <div class="data-item"><strong>Peso Actual:</strong> <span id="viewPesoActual"></span></div>
                    <div class="data-item"><strong>Diferencia:</strong> <span id="viewDiferenciaPeso"></span></div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Indicadores (Pliegues)</legend>
                <div class="data-grid">
                    <div class="data-item"><strong>PT:</strong> <span id="viewPT"></span></div>
                    <div class="data-item"><strong>PSE:</strong> <span id="viewPSE"></span></div>
                    <div class="data-item"><strong>PSI:</strong> <span id="viewPSI"></span></div>
                    <div class="data-item"><strong>PA:</strong> <span id="viewPA"></span></div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Resultados Calculados</legend>
                <div class="data-grid">
                    <div class="data-item"><strong>% Tejido Graso:</strong> <span id="viewTejidoGraso"></span></div>
                    <div class="data-item"><strong>Kilos de Grasa:</strong> <span id="viewKilosGrasa"></span></div>
                    <div class="data-item"><strong>Cambio Grasa:</strong> <span id="viewCambioGrasa"></span></div>
                    <div class="data-item"><strong>Cambio Masa Magra:</strong> <span id="viewCambioMasaMagra"></span></div>
                </div>
            </fieldset>
        </div>
    </div>

    <!-- MODAL PARA OPCIONES DE EXPORTACIÓN A PDF -->
    <div id="exportPdfModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Opciones de Exportación a PDF</h2>
            <form id="exportOptionsForm">
                <p>Selecciona el rango de mediciones a incluir en el informe.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="dateFrom">Desde la fecha:</label>
                        <input type="date" id="dateFrom" class="input-field">
                    </div>
                    <div class="form-group">
                        <label for="dateTo">Hasta la fecha:</label>
                        <input type="date" id="dateTo" class="input-field">
                    </div>
                </div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="includeMenuCheck">
                    <label for="includeMenuCheck">Adjuntar menú al informe</label>
                </div>
                <div id="menuSelectionContainer" class="form-group" style="display: none;">
                    <label for="menuSelect">Selecciona un menú</label>
                    <select id="menuSelect" class="input-field"></select>
                </div>
                <button type="submit" class="btn-guardar">Generar PDF</button>
            </form>
        </div>
    </div>
    
    <!-- OVERLAY DE CARGA PARA PDF -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>Generando PDF, por favor espera...</p>
    </div>

    <!-- SDKs de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    
    <!-- Scripts de la página -->
    <script src="mediciones.js"></script>
    <script src="main.js"></script>
</body>
</html>
